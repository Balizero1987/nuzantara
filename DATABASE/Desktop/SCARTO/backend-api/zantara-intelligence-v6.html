<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZANTARA Intelligence v6 - Complete AI Assistant</title>

    <!-- Favicon & Theme -->
    <link rel="icon" type="image/png" href="zantara_logo_transparent.png">
    <meta name="theme-color" content="#6366f1">
    <meta name="description" content="ZANTARA Intelligence v6 - Complete AI assistant with 125+ capabilities">

    <!-- Geist Font -->
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            background: linear-gradient(135deg, #1a0033 0%, #2D1B69 50%, #6B46C1 100%);
        }

        /* Sidebar - Capability Explorer */
        .sidebar {
            width: 320px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #a78bfa;
        }

        .capability-search {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px 12px;
            color: white;
            font-size: 14px;
            outline: none;
        }

        .capability-search::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .capabilities-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .capability-category {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .category-header {
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.03);
            cursor: pointer;
            display: flex;
            justify-content: between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
            color: #e5e7eb;
        }

        .category-header:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .category-icon {
            margin-right: 10px;
            font-size: 16px;
        }

        .capability-items {
            padding: 8px 0;
            display: none;
        }

        .capability-items.expanded {
            display: block;
        }

        .capability-item {
            padding: 8px 20px 8px 50px;
            cursor: pointer;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.2s;
        }

        .capability-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #a78bfa;
        }

        .capability-item.active {
            background: rgba(167, 139, 250, 0.2);
            color: #a78bfa;
            font-weight: 500;
        }

        /* Main Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .assistant-info h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            background: linear-gradient(45deg, #ffffff, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .assistant-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Config button + panel */
        .config-button {
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
        }
        .config-panel {
            position: absolute;
            top: 64px;
            right: 20px;
            width: 320px;
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 12px;
            display: none;
            z-index: 10;
        }
        .config-panel label { display:block; font-size:12px; margin:8px 0 4px; color:#c7c7d3; }
        .config-panel input { width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); color:#fff; }
        .config-actions { display:flex; gap:8px; margin-top:10px; }
        .btn-small { padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.12); color:#fff; cursor:pointer; font-size:12px; }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #a78bfa, #c084fc);
            color: #1a0033;
        }

        .message-content {
            max-width: 70%;
            background: rgba(255, 255, 255, 0.1);
            padding: 16px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message.user .message-content {
            background: rgba(99, 102, 241, 0.3);
        }

        .message.assistant .message-content {
            background: rgba(167, 139, 250, 0.2);
        }

        .message-meta {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
        }

        .handler-info {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 10px;
            color: #10b981;
            font-weight: 500;
        }

        /* Input Area */
        .input-container {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-suggestions {
            margin-bottom: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .suggestion-chip {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-chip:hover {
            background: rgba(167, 139, 250, 0.3);
            color: #a78bfa;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px;
        }

        .input-field {
            flex: 1;
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            resize: none;
            outline: none;
            max-height: 120px;
            min-height: 20px;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .send-button {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .send-button:hover {
            background: linear-gradient(135deg, #5855eb, #7c3aed);
            transform: translateY(-1px);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading States */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            font-style: italic;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            animation: typingPulse 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingPulse {
            0%, 60%, 100% { opacity: 0.6; }
            30% { opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .message-content {
                max-width: 85%;
            }
        }

        /* Scrollbar Styling */
        .messages-container::-webkit-scrollbar,
        .capabilities-list::-webkit-scrollbar {
            width: 4px;
        }

        .messages-container::-webkit-scrollbar-track,
        .capabilities-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .messages-container::-webkit-scrollbar-thumb,
        .capabilities-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar - Capability Explorer -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>üß† Capabilities</h3>
                <input type="text" class="capability-search" placeholder="Search capabilities..." id="capabilitySearch">
            </div>
            <div class="capabilities-list" id="capabilitiesList">
                <!-- Capabilities will be populated by JavaScript -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <div class="assistant-info">
                    <h2>ZANTARA Intelligence v6</h2>
                    <p>Complete AI Assistant ‚Ä¢ 125+ Capabilities ‚Ä¢ Bali Zero</p>
                </div>
                <div style="display:flex; align-items:center; gap:12px; position: relative;">
                    <button class="config-button" id="configButton">‚öô API</button>
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">Checking...</span>
                    </div>
                    <div class="config-panel" id="configPanel">
                        <label>API Base URL</label>
                        <input id="apiBaseInput" placeholder="http://localhost:8080" />
                        <label style="margin-top:8px;">API Key</label>
                        <input id="apiKeyInput" placeholder="zantara-internal-dev-key-2025" />
                        <div class="config-actions">
                            <button class="btn-small" id="saveConfigBtn">Save</button>
                            <button class="btn-small" id="pingBtn">Ping</button>
                            <button class="btn-small" id="closeConfigBtn">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="message assistant">
                    <div class="message-avatar">Z</div>
                    <div class="message-content">
                        <p>Welcome to ZANTARA Intelligence v6! I'm your complete AI assistant with access to 125+ specialized capabilities.</p>
                        <p style="margin-top: 12px; font-size: 13px; opacity: 0.8;">I can help you with:</p>
                        <ul style="margin: 8px 0 0 16px; font-size: 13px; opacity: 0.8;">
                            <li>Business operations & team management</li>
                            <li>AI conversations & intelligent analysis</li>
                            <li>Google Workspace integration</li>
                            <li>Pricing & quote generation</li>
                            <li>Advanced analytics & reporting</li>
                            <li>And much more...</li>
                        </ul>
                        <p style="margin-top: 12px; font-size: 13px; color: #a78bfa;">üí° Explore the capabilities sidebar or just tell me what you need!</p>
                        <div class="message-meta">
                            <span>System Message</span>
                            <span class="handler-info">system.welcome</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-suggestions" id="inputSuggestions">
                    <div class="suggestion-chip" onclick="sendSuggestion('Show me all team members')">üë• Team Members</div>
                    <div class="suggestion-chip" onclick="sendSuggestion('What are your pricing packages?')">üí∞ Pricing Info</div>
                    <div class="suggestion-chip" onclick="sendSuggestion('Help me with company setup in Bali')">üè¢ Company Setup</div>
                    <div class="suggestion-chip" onclick="sendSuggestion('Analyze team performance')">üìä Analytics</div>
                </div>
                <div class="input-wrapper">
                    <textarea class="input-field" id="messageInput" placeholder="Ask me anything... I have 125+ capabilities to help you!" rows="1"></textarea>
                    <button class="send-button" id="sendButton" onclick="sendMessage()">
                        <span>Send</span>
                        <span>‚ö°</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ZANTARA Intelligence v6 - Complete Handler System
        // Dynamic API config: query > localStorage > default (localhost in dev)
        const qs = new URLSearchParams(window.location.search);
        const DEFAULT_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
          ? 'http://localhost:8080'
          : 'https://api.balizero.com';
        let API_BASE = qs.get('api') || localStorage.getItem('API_BASE') || DEFAULT_BASE;
        let API_KEY = qs.get('key') || localStorage.getItem('API_KEY') || 'zantara-internal-dev-key-2025';

        let conversationHistory = [];
        let isLoading = false;

        // Complete capabilities database - all 125+ handlers mapped
        const capabilities = {
            'Business Operations': {
                icon: 'üè¢',
                handlers: [
                    { key: 'contact.info', name: 'Company Contact Info', desc: 'Get Bali Zero contact information' },
                    { key: 'lead.save', name: 'Save Lead', desc: 'Save potential client information' },
                    { key: 'quote.generate', name: 'Generate Quote', desc: 'Create service quotes and pricing' },
                    { key: 'pricing.official', name: 'Official Pricing', desc: 'Get 2025 official pricing packages' },
                    { key: 'bali.zero.pricing', name: 'Bali Zero Pricing', desc: 'Complete pricing breakdown' },
                    { key: 'price.lookup', name: 'Quick Price Check', desc: 'Fast price lookup by service' }
                ]
            },
            'Team Management': {
                icon: 'üë•',
                handlers: [
                    { key: 'team.list', name: 'List All Team', desc: 'Show all 23 team members' },
                    { key: 'team.get', name: 'Team Member Info', desc: 'Get specific member details' },
                    { key: 'team.departments', name: 'Department Structure', desc: 'Show organizational structure' },
                    { key: 'identity.resolve', name: 'Identity Resolution', desc: 'Identify team members by email' }
                ]
            },
            'AI & Intelligence': {
                icon: 'üß†',
                handlers: [
                    { key: 'ai.chat', name: 'AI Conversation', desc: 'General AI chat with fallback system' },
                    { key: 'openai.chat', name: 'OpenAI Chat', desc: 'OpenAI GPT conversation' },
                    { key: 'claude.chat', name: 'Claude Chat', desc: 'Anthropic Claude conversation' },
                    { key: 'gemini.chat', name: 'Gemini Chat', desc: 'Google Gemini conversation' },
                    { key: 'cohere.chat', name: 'Cohere Chat', desc: 'Cohere AI conversation' },
                    { key: 'ai.anticipate', name: 'Anticipate Needs', desc: 'Predictive AI assistance' },
                    { key: 'ai.learn', name: 'Learn & Adapt', desc: 'Adaptive learning system' },
                    { key: 'xai.explain', name: 'Explain AI', desc: 'AI decision explanations' }
                ]
            },
            'ZANTARA Framework': {
                icon: 'üéØ',
                handlers: [
                    { key: 'zantara.personality.profile', name: 'Personality Profile', desc: 'Analyze team member personalities' },
                    { key: 'zantara.attune', name: 'Attune System', desc: 'Sync with team dynamics' },
                    { key: 'zantara.synergy.map', name: 'Synergy Mapping', desc: 'Map team collaboration patterns' },
                    { key: 'zantara.anticipate.needs', name: 'Anticipate Needs', desc: 'Predict team requirements' },
                    { key: 'zantara.communication.adapt', name: 'Communication Adapt', desc: 'Adapt communication style' },
                    { key: 'zantara.learn.together', name: 'Learn Together', desc: 'Collaborative learning system' },
                    { key: 'zantara.mood.sync', name: 'Mood Sync', desc: 'Team mood synchronization' },
                    { key: 'zantara.conflict.mediate', name: 'Conflict Mediation', desc: 'Resolve team conflicts' },
                    { key: 'zantara.growth.track', name: 'Growth Tracking', desc: 'Track personal development' },
                    { key: 'zantara.celebration.orchestrate', name: 'Celebration', desc: 'Orchestrate team celebrations' }
                ]
            },
            'Advanced ZANTARA': {
                icon: 'üöÄ',
                handlers: [
                    { key: 'zantara.emotional.profile.advanced', name: 'Advanced Emotional Profile', desc: 'Deep emotional intelligence analysis' },
                    { key: 'zantara.conflict.prediction', name: 'Conflict Prediction', desc: 'Predict potential team conflicts' },
                    { key: 'zantara.multi.project.orchestration', name: 'Multi-Project Orchestration', desc: 'Manage multiple projects intelligently' },
                    { key: 'zantara.client.relationship.intelligence', name: 'Client Relationship Intelligence', desc: 'Optimize client relationships' },
                    { key: 'zantara.cultural.intelligence.adaptation', name: 'Cultural Intelligence', desc: 'Adapt to cultural contexts' },
                    { key: 'zantara.performance.optimization', name: 'Performance Optimization', desc: 'Optimize team performance' }
                ]
            },
            'Google Workspace': {
                icon: 'üìÑ',
                handlers: [
                    { key: 'drive.upload', name: 'Drive Upload', desc: 'Upload files to Google Drive' },
                    { key: 'drive.list', name: 'Drive List', desc: 'List Drive files' },
                    { key: 'drive.search', name: 'Drive Search', desc: 'Search Drive content' },
                    { key: 'drive.read', name: 'Drive Read', desc: 'Read Drive files' },
                    { key: 'sheets.read', name: 'Sheets Read', desc: 'Read Google Sheets data' },
                    { key: 'sheets.append', name: 'Sheets Append', desc: 'Add data to sheets' },
                    { key: 'sheets.create', name: 'Sheets Create', desc: 'Create new spreadsheet' },
                    { key: 'docs.create', name: 'Docs Create', desc: 'Create Google Documents' },
                    { key: 'docs.read', name: 'Docs Read', desc: 'Read document content' },
                    { key: 'docs.update', name: 'Docs Update', desc: 'Update documents' },
                    { key: 'slides.create', name: 'Slides Create', desc: 'Create presentations' },
                    { key: 'slides.read', name: 'Slides Read', desc: 'Read presentation content' },
                    { key: 'slides.update', name: 'Slides Update', desc: 'Update presentations' }
                ]
            },
            'Communication': {
                icon: 'üí¨',
                handlers: [
                    { key: 'gmail.send', name: 'Send Email', desc: 'Send emails via Gmail' },
                    { key: 'gmail.list', name: 'List Emails', desc: 'List Gmail messages' },
                    { key: 'gmail.read', name: 'Read Email', desc: 'Read specific emails' },
                    { key: 'slack.notify', name: 'Slack Notification', desc: 'Send Slack messages' },
                    { key: 'discord.notify', name: 'Discord Notification', desc: 'Send Discord messages' },
                    { key: 'googlechat.notify', name: 'Google Chat', desc: 'Send Google Chat messages' },
                    { key: 'contacts.list', name: 'List Contacts', desc: 'List Google Contacts' },
                    { key: 'contacts.create', name: 'Create Contact', desc: 'Create new contacts' }
                ]
            },
            'Calendar & Scheduling': {
                icon: 'üìÖ',
                handlers: [
                    { key: 'calendar.create', name: 'Create Event', desc: 'Create calendar events' },
                    { key: 'calendar.list', name: 'List Events', desc: 'List calendar events' },
                    { key: 'calendar.get', name: 'Get Event', desc: 'Get specific event details' }
                ]
            },
            'Memory & Storage': {
                icon: 'üíæ',
                handlers: [
                    { key: 'memory.save', name: 'Save Memory', desc: 'Save information to memory system' },
                    { key: 'memory.search', name: 'Search Memory', desc: 'Search stored information' },
                    { key: 'memory.retrieve', name: 'Retrieve Memory', desc: 'Retrieve specific memories' }
                ]
            },
            'Translation & Language': {
                icon: 'üåê',
                handlers: [
                    { key: 'translate.text', name: 'Translate Text', desc: 'Translate text between languages' },
                    { key: 'translate.batch', name: 'Batch Translation', desc: 'Translate multiple texts' },
                    { key: 'translate.detect', name: 'Detect Language', desc: 'Detect text language' },
                    { key: 'translate.template', name: 'Translation Template', desc: 'Use translation templates' }
                ]
            },
            'Creative & Media': {
                icon: 'üé®',
                handlers: [
                    { key: 'vision.analyze', name: 'Vision Analysis', desc: 'Analyze images and visual content' },
                    { key: 'vision.extract', name: 'Extract from Images', desc: 'Extract text from images' },
                    { key: 'speech.transcribe', name: 'Speech Transcription', desc: 'Convert speech to text' },
                    { key: 'speech.synthesize', name: 'Speech Synthesis', desc: 'Convert text to speech' },
                    { key: 'language.sentiment', name: 'Sentiment Analysis', desc: 'Analyze text sentiment' }
                ]
            },
            'Analytics & Reports': {
                icon: 'üìä',
                handlers: [
                    { key: 'dashboard.main', name: 'Main Dashboard', desc: 'System overview dashboard' },
                    { key: 'dashboard.conversations', name: 'Conversation Analytics', desc: 'Chat analytics dashboard' },
                    { key: 'dashboard.services', name: 'Services Dashboard', desc: 'Service usage analytics' },
                    { key: 'dashboard.handlers', name: 'Handler Analytics', desc: 'Handler performance metrics' },
                    { key: 'dashboard.health', name: 'System Health', desc: 'System health monitoring' },
                    { key: 'dashboard.users', name: 'User Analytics', desc: 'User activity analytics' },
                    { key: 'zantara.dashboard.overview', name: 'ZANTARA Overview', desc: 'ZANTARA system overview' },
                    { key: 'zantara.team.health.monitor', name: 'Team Health Monitor', desc: 'Monitor team health metrics' },
                    { key: 'zantara.performance.analytics', name: 'Performance Analytics', desc: 'Team performance analytics' },
                    { key: 'zantara.system.diagnostics', name: 'System Diagnostics', desc: 'ZANTARA system diagnostics' }
                ]
            },
            'Maps & Location': {
                icon: 'üó∫Ô∏è',
                handlers: [
                    { key: 'maps.directions', name: 'Get Directions', desc: 'Get navigation directions' },
                    { key: 'maps.places', name: 'Find Places', desc: 'Search for places and locations' },
                    { key: 'maps.placeDetails', name: 'Place Details', desc: 'Get detailed place information' }
                ]
            },
            'Activity Tracking': {
                icon: 'üìà',
                handlers: [
                    { key: 'daily.recap.update', name: 'Update Daily Recap', desc: 'Update daily activity recap' },
                    { key: 'daily.recap.current', name: 'Current Daily Recap', desc: 'Get current daily activity' },
                    { key: 'collaborator.daily', name: 'Collaborator Daily', desc: 'Get collaborator daily activity' },
                    { key: 'activity.track', name: 'Track Activity', desc: 'Track team activities' }
                ]
            },
            'Oracle & Predictions': {
                icon: 'üîÆ',
                handlers: [
                    { key: 'oracle.simulate', name: 'Oracle Simulation', desc: 'Run predictive simulations' },
                    { key: 'oracle.analyze', name: 'Oracle Analysis', desc: 'Analyze patterns and trends' },
                    { key: 'oracle.predict', name: 'Oracle Prediction', desc: 'Make intelligent predictions' }
                ]
            },
            'System & OAuth': {
                icon: 'üîê',
                handlers: [
                    { key: 'oauth2.status', name: 'OAuth2 Status', desc: 'Check OAuth2 token status' },
                    { key: 'oauth2.refresh', name: 'OAuth2 Refresh', desc: 'Refresh OAuth2 tokens' },
                    { key: 'oauth2.available', name: 'OAuth2 Available', desc: 'Check OAuth2 availability' },
                    { key: 'onboarding.start', name: 'Start Onboarding', desc: 'Begin user onboarding process' }
                ]
            }
        };

        // Intelligent Handler Detection System
        class IntelligentRouter {
            constructor() {
                this.handlerKeywords = this.buildKeywordMap();
            }

            buildKeywordMap() {
                const map = new Map();

                // Business & Contact
                map.set('contact.info', ['contact', 'info', 'company info', 'bali zero', 'office', 'address', 'phone', 'email', 'whatsapp']);
                map.set('lead.save', ['lead', 'save contact', 'register', 'new client', 'potential client']);
                map.set('quote.generate', ['quote', 'quotation', 'estimate', 'pricing for', 'cost for', 'price for']);
                map.set('pricing.official', ['pricing', 'prices', 'cost', 'how much', 'tariff', 'fee', 'rate']);

                // Team
                map.set('team.list', ['team', 'members', 'staff', 'employees', 'who works', 'all team', 'team members']);
                map.set('team.get', ['team member', 'employee info', 'staff info', 'who is']);
                map.set('identity.resolve', ['who is', 'identity', 'profile of', 'information about']);

                // AI
                map.set('ai.chat', ['chat', 'talk', 'conversation', 'ask', 'tell', 'explain', 'help']);
                map.set('openai.chat', ['openai', 'gpt', 'chatgpt']);
                map.set('claude.chat', ['claude', 'anthropic']);
                map.set('gemini.chat', ['gemini', 'google ai', 'bard']);
                map.set('cohere.chat', ['cohere']);

                // ZANTARA
                map.set('zantara.personality.profile', ['personality', 'profile', 'character', 'traits', 'behavior']);
                map.set('zantara.synergy.map', ['synergy', 'collaboration', 'team dynamics', 'working together']);
                map.set('zantara.mood.sync', ['mood', 'emotion', 'feeling', 'sentiment', 'atmosphere']);

                // Google Workspace
                map.set('drive.upload', ['upload file', 'upload to drive', 'put file']);
                map.set('drive.list', ['drive files', 'my files', 'google drive', 'list files']);
                map.set('drive.search', ['search files', 'find file', 'search drive']);
                map.set('drive.read', ['read drive file', 'download file']);
                map.set('sheets.create', ['create sheet', 'new spreadsheet']);
                map.set('sheets.read', ['spreadsheet', 'sheet', 'google sheets', 'read sheet']);
                map.set('sheets.append', ['append sheet', 'add rows', 'add data']);
                map.set('docs.create', ['create doc', 'google docs', 'new document']);
                map.set('docs.read', ['read doc', 'document content']);
                map.set('docs.update', ['update doc', 'edit doc']);
                map.set('slides.create', ['create slides', 'new presentation']);
                map.set('slides.read', ['read slides', 'presentation content']);
                map.set('slides.update', ['update slides', 'edit slides']);
                map.set('gmail.send', ['send email', 'email', 'message']);
                map.set('gmail.list', ['list emails', 'inbox', 'emails']);
                map.set('gmail.read', ['read email', 'open email', 'message id']);
                map.set('googlechat.notify', ['google chat', 'spaces', 'room']);
                map.set('slack.notify', ['slack']);
                map.set('discord.notify', ['discord']);
                map.set('contacts.list', ['contacts', 'google contacts', 'list contacts']);
                map.set('contacts.create', ['create contact', 'new contact']);

                // Analytics
                map.set('dashboard.main', ['dashboard', 'overview', 'stats', 'metrics']);
                map.set('dashboard.conversations', ['conversation analytics', 'conversations dashboard']);
                map.set('dashboard.services', ['services analytics', 'services dashboard']);
                map.set('dashboard.handlers', ['handlers analytics', 'handlers dashboard']);
                map.set('dashboard.health', ['system health', 'health dashboard']);
                map.set('dashboard.users', ['user analytics', 'users dashboard']);
                map.set('zantara.dashboard.overview', ['zantara overview']);
                map.set('zantara.performance.analytics', ['performance', 'analytics', 'analysis', 'insights']);
                map.set('zantara.team.health.monitor', ['team health', 'team monitor']);

                // Team / Identity
                map.set('team.departments', ['departments', 'org structure', 'organizational structure']);

                // Translation & Language
                map.set('translate.text', ['translate', 'translation']);
                map.set('translate.batch', ['batch translate', 'multiple translations']);
                map.set('translate.detect', ['detect language']);

                // Vision & Speech
                map.set('vision.analyze', ['vision', 'image analysis', 'analyze image']);
                map.set('vision.extract', ['ocr', 'extract text', 'image text']);
                map.set('speech.transcribe', ['transcribe', 'speech to text', 'audio']);
                map.set('speech.synthesize', ['text to speech', 'speak']);

                // Maps
                map.set('maps.directions', ['directions', 'route', 'navigate']);
                map.set('maps.places', ['places', 'search places', 'find place']);
                map.set('maps.placeDetails', ['place details', 'place info']);

                // OAuth2 / Onboarding
                map.set('oauth2.status', ['oauth2 status', 'token status']);
                map.set('oauth2.available', ['oauth2 available', 'auth available']);
                map.set('onboarding.start', ['onboarding']);

                return map;
            }

            detectIntent(message, history = []) {
                const lower = message.toLowerCase();
                // Direct "Use <handler>" override
                const useMatch = lower.match(/^use\s+([a-z0-9_.\-]+)/i);
                if (useMatch && useMatch[1]) {
                    return {
                        handler: useMatch[1],
                        confidence: 1.0,
                        alternatives: [],
                        reason: 'Direct handler selection via "Use <handler>"'
                    };
                }
                const scores = new Map();

                // Score each handler based on keyword matches
                for (const [handler, keywords] of this.handlerKeywords) {
                    let score = 0;
                    for (const keyword of keywords) {
                        if (lower.includes(keyword)) {
                            score += keyword.length; // Longer matches get higher scores
                        }
                    }
                    if (score > 0) {
                        scores.set(handler, score);
                    }
                }

                // Sort by confidence
                const sorted = Array.from(scores.entries()).sort((a, b) => b[1] - a[1]);

                if (sorted.length === 0) {
                    return {
                        handler: 'ai.chat',
                        confidence: 0.3,
                        alternatives: ['contact.info', 'pricing.official'],
                        reason: 'No specific intent detected, defaulting to AI chat'
                    };
                }

                const [topHandler, topScore] = sorted[0];
                const confidence = Math.min(topScore / 20, 1.0); // Normalize score to 0-1

                return {
                    handler: topHandler,
                    confidence: confidence,
                    alternatives: sorted.slice(1, 4).map(([handler]) => handler),
                    reason: `Detected intent: ${topHandler} (confidence: ${Math.round(confidence * 100)}%)`
                };
            }

            extractParameters(message, handler) {
                const params = {};
                const lower = message.toLowerCase();
                // Extract trailing content after colon if using "Use <handler>: ..."
                let trailing = '';
                const colonIdx = message.indexOf(':');
                if (/^use\s+/i.test(message) && colonIdx > -1) {
                    trailing = message.slice(colonIdx + 1).trim();
                }

                // Extract common parameters
                if (handler.includes('team.get') || handler.includes('identity.resolve')) {
                    // Try to extract email or name
                    const emailMatch = message.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
                    if (emailMatch) {
                        params.email = emailMatch[1];
                    } else {
                        // Extract potential names (words that start with capital letters)
                        const nameMatches = message.match(/([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/g);
                        if (nameMatches) {
                            params.name = nameMatches[0];
                        }
                    }
                }

                if (handler.includes('quote.generate') || handler.includes('pricing')) {
                    // Extract service type
                    if (lower.includes('visa')) params.service = 'visa';
                    else if (lower.includes('company')) params.service = 'company';
                    else if (lower.includes('tax')) params.service = 'tax';
                    else if (lower.includes('real estate')) params.service = 'real-estate';
                }

                if (handler.includes('ai.') || handler.includes('.chat')) {
                    // Safe string handling for JSON; prefer trailing
                    const base = trailing || message;
                    const safeMessage = base.replace(/[\u0000-\u001F\u007F-\u009F]/g, "").trim();
                    params.message = safeMessage;
                    params.prompt = safeMessage;
                }

                // Drive search quick param
                if (handler === 'drive.search' && trailing && !params.query) {
                    params.query = trailing;
                }

                // Gmail send quick parse: "to: ..., subject: ..., body: ..."
                if (handler === 'gmail.send' && trailing) {
                    const toMatch = trailing.match(/to\s*:\s*([^,]+)(?:,|$)/i);
                    const subjectMatch = trailing.match(/subject\s*:\s*([^,]+)(?:,|$)/i);
                    const bodyMatch = trailing.match(/body\s*:\s*([\s\S]+)/i);
                    if (toMatch) params.to = toMatch[1].trim();
                    if (subjectMatch) params.subject = subjectMatch[1].trim();
                    if (bodyMatch) params.body = bodyMatch[1].trim();
                }

                return params;
            }
        }

        const router = new IntelligentRouter();

        // Health check + API config UI
        async function pingHealth() {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            try {
                const res = await fetch(`${API_BASE}/health`);
                if (!res.ok) throw new Error('bad_status');
                const data = await res.json().catch(() => ({}));
                dot.style.background = '#10b981';
                text.textContent = (data?.ok || data?.status || 'Online') + ' ‚Ä¢ ' + (data?.version || 'v5.2.0');
            } catch (e) {
                dot.style.background = '#ef4444';
                text.textContent = 'Offline';
            }
        }

        function setupConfigPanel() {
            const btn = document.getElementById('configButton');
            const panel = document.getElementById('configPanel');
            const apiInput = document.getElementById('apiBaseInput');
            const keyInput = document.getElementById('apiKeyInput');
            const saveBtn = document.getElementById('saveConfigBtn');
            const closeBtn = document.getElementById('closeConfigBtn');
            const pingBtn = document.getElementById('pingBtn');

            apiInput.value = API_BASE;
            keyInput.value = API_KEY;

            btn.onclick = () => { panel.style.display = panel.style.display === 'block' ? 'none' : 'block'; };
            closeBtn.onclick = () => { panel.style.display = 'none'; };
            saveBtn.onclick = () => {
                API_BASE = apiInput.value.trim() || API_BASE;
                API_KEY = keyInput.value.trim() || API_KEY;
                localStorage.setItem('API_BASE', API_BASE);
                localStorage.setItem('API_KEY', API_KEY);
                panel.style.display = 'none';
                pingHealth();
            };
            pingBtn.onclick = () => pingHealth();
        }

        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            initializeCapabilities();
            setupEventListeners();
            adjustTextarea();
            setupConfigPanel();
            pingHealth();
            setInterval(pingHealth, 30000);
        });

        function initializeCapabilities() {
            const capabilitiesList = document.getElementById('capabilitiesList');

            for (const [categoryName, categoryData] of Object.entries(capabilities)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'capability-category';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'category-header';
                headerDiv.onclick = () => toggleCategory(categoryName);
                headerDiv.innerHTML = `
                    <span><span class="category-icon">${categoryData.icon}</span>${categoryName}</span>
                    <span>${categoryData.handlers.length}</span>
                `;

                const itemsDiv = document.createElement('div');
                itemsDiv.className = 'capability-items';
                itemsDiv.id = `category-${categoryName.replace(/\s+/g, '-')}`;

                categoryData.handlers.forEach(handler => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'capability-item';
                    itemDiv.title = handler.desc;
                    itemDiv.textContent = handler.name;
                    itemDiv.onclick = () => selectCapability(handler);
                    itemsDiv.appendChild(itemDiv);
                });

                categoryDiv.appendChild(headerDiv);
                categoryDiv.appendChild(itemsDiv);
                capabilitiesList.appendChild(categoryDiv);
            }
        }

        function toggleCategory(categoryName) {
            const itemsDiv = document.getElementById(`category-${categoryName.replace(/\s+/g, '-')}`);
            itemsDiv.classList.toggle('expanded');
        }

        function selectCapability(handler) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value = `Use ${handler.key}: ${handler.desc}`;
            messageInput.focus();

            // Highlight selected capability
            document.querySelectorAll('.capability-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function setupEventListeners() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');

            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            messageInput.addEventListener('input', adjustTextarea);

            // Capability search
            const capabilitySearch = document.getElementById('capabilitySearch');
            capabilitySearch.addEventListener('input', function(e) {
                filterCapabilities(e.target.value);
            });
        }

        function filterCapabilities(searchTerm) {
            const categories = document.querySelectorAll('.capability-category');
            const term = searchTerm.toLowerCase();

            categories.forEach(category => {
                const items = category.querySelectorAll('.capability-item');
                let hasVisibleItems = false;

                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    const isVisible = text.includes(term) || term === '';
                    item.style.display = isVisible ? 'block' : 'none';
                    if (isVisible) hasVisibleItems = true;
                });

                category.style.display = hasVisibleItems || term === '' ? 'block' : 'none';
            });
        }

        function adjustTextarea() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function sendSuggestion(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message || isLoading) return;

            isLoading = true;
            updateSendButton(true);

            // Add user message to chat
            addMessage('user', message);
            messageInput.value = '';
            adjustTextarea();

            // Show typing indicator
            const typingId = showTypingIndicator();

            try {
                // Use intelligent routing
                const intent = router.detectIntent(message, conversationHistory);
                const params = router.extractParameters(message, intent.handler);

                console.log('üß† ZANTARA Router:', intent);
                console.log('üì° Sending params:', params);
                console.log('üì® Request body will be:', { key: intent.handler, params: params });

                // Make API call with safe JSON handling
                let requestBody;
                try {
                    requestBody = JSON.stringify({
                        key: intent.handler,
                        params: params
                    });
                } catch (jsonError) {
                    console.error('JSON stringify error:', jsonError);
                    addMessage('zantara', `‚ùå Errore nella richiesta: caratteri non supportati nel messaggio. Prova a riscrivere senza caratteri speciali.`, intent);
                    return;
                }

                const response = await fetch(`${API_BASE}/call`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': API_KEY
                    },
                    body: requestBody
                });

                const result = await response.json();

                // Remove typing indicator
                removeTypingIndicator(typingId);

                // Format and add response
                const formattedResponse = formatResponse(result, intent.handler);
                addMessage('assistant', formattedResponse, intent);

                // Update conversation history
                conversationHistory.push({
                    message: message,
                    response: result,
                    handler: intent.handler,
                    timestamp: Date.now()
                });

            } catch (error) {
                removeTypingIndicator(typingId);
                console.error('API Error:', error);
                addMessage('assistant', `I apologize, but I encountered an error: ${error.message}`, {
                    handler: 'error',
                    confidence: 0
                });
            }

            isLoading = false;
            updateSendButton(false);
        }

        function formatResponse(result, handler) {
            if (!result.ok) {
                return `‚ùå Error: ${result.error || 'Something went wrong'}`;
            }

            const data = result.data;

            // Format based on handler type
            if (handler === 'team.list' && data && data.members) {
                let response = `üë• **Bali Zero Team** (${data.members.length} members)\n\n`;

                const departments = {};
                data.members.forEach(member => {
                    const dept = member.department || 'Other';
                    if (!departments[dept]) departments[dept] = [];
                    departments[dept].push(member);
                });

                Object.entries(departments).forEach(([dept, members]) => {
                    response += `**${dept}:**\n`;
                    members.forEach(member => {
                        response += `‚Ä¢ ${member.name} - ${member.role}\n`;
                    });
                    response += '\n';
                });

                return response;
            }

            if (handler === 'pricing.official' && data && data.categories) {
                let response = `üí∞ **Bali Zero Official Pricing 2025**\n\n`;

                Object.entries(data.categories).forEach(([category, services]) => {
                    response += `**${category.toUpperCase()}:**\n`;
                    Object.entries(services).forEach(([service, info]) => {
                        response += `‚Ä¢ ${service}: ‚Ç¨${info.price} (${info.timeline})\n`;
                    });
                    response += '\n';
                });

                return response;
            }

            if (handler === 'contact.info' && data) {
                return `üè¢ **Bali Zero Contact Information**\n\n` +
                       `**Company:** ${data.company}\n` +
                       `**Tagline:** ${data.tagline}\n` +
                       `**Email:** ${data.communication.email}\n` +
                       `**WhatsApp:** ${data.communication.whatsapp}\n` +
                       `**Instagram:** ${data.communication.instagram}\n` +
                       `**Office:** ${data.office.location}\n` +
                       `**Availability:** ${data.availability}`;
            }

            if (handler.includes('ai.') || handler.includes('.chat')) {
                return data.response || data.message || JSON.stringify(data, null, 2);
            }

            // Generic formatting
            if (typeof data === 'string') return data;
            if (data.message) return data.message;
            if (data.response) return data.response;

            return `‚úÖ Success!\n\n\`\`\`json\n${JSON.stringify(data, null, 2)}\n\`\`\``;
        }

        function addMessage(type, content, intent = null) {
            const messagesContainer = document.getElementById('messagesContainer');

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.textContent = type === 'user' ? 'U' : 'Z';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // Format content with markdown-like styling
            const formattedContent = formatContentDisplay(content);
            contentDiv.innerHTML = formattedContent;

            // Add metadata
            const metaDiv = document.createElement('div');
            metaDiv.className = 'message-meta';

            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            metaDiv.innerHTML = `<span>${timestamp}</span>`;

            if (intent && intent.handler) {
                const handlerInfo = document.createElement('span');
                handlerInfo.className = 'handler-info';
                handlerInfo.textContent = intent.handler;
                metaDiv.appendChild(handlerInfo);
            }

            contentDiv.appendChild(metaDiv);
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatContentDisplay(content) {
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>')
                .replace(/```json\n([\s\S]*?)\n```/g, '<pre style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin: 8px 0; overflow-x: auto;"><code>$1</code></pre>');
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('messagesContainer');

            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typing-indicator';

            typingDiv.innerHTML = `
                <div class="message-avatar">Z</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span>ZANTARA is thinking</span>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;

            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return typingDiv.id;
        }

        function removeTypingIndicator(id) {
            const typingDiv = document.getElementById(id);
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        function updateSendButton(loading) {
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = loading;
            sendButton.innerHTML = loading
                ? '<span>Sending</span><span>‚è≥</span>'
                : '<span>Send</span><span>‚ö°</span>';
        }

        // Initialize expanded state for main categories
        setTimeout(() => {
            ['Business Operations', 'AI & Intelligence', 'Team Management'].forEach(categoryName => {
                const itemsDiv = document.getElementById(`category-${categoryName.replace(/\s+/g, '-')}`);
                if (itemsDiv) {
                    itemsDiv.classList.add('expanded');
                }
            });
        }, 500);
    </script>
</body>
</html>
