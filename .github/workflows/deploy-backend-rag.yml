name: Deploy Backend RAG to Fly.io

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/backend-rag/**'
      - '.github/workflows/deploy-backend-rag.yml'
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy RAG Backend to Fly.io
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        working-directory: apps/backend-rag
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "ðŸš€ Deploying backend-rag to Fly.io..."
          flyctl deploy --remote-only --app nuzantara-rag

      - name: Verify deployment
        run: |
          echo "â³ Waiting 30 seconds for deployment to stabilize..."
          sleep 30

          echo "ðŸ” Verifying deployment..."
          echo "## ðŸš€ Backend RAG Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App:** nuzantara-rag" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** Singapore (sin)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** [\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${GITHUB_SHA})" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Features deployed:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PHASE 1: Tools Visibility System" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Enhanced BaliZeroRequest (tools + tool_choice)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Enhanced BaliZeroResponse (tools_used)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… IntelligentRouter with frontend tools priority" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Verify deployment:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Note: Health endpoint may require auth" >> $GITHUB_STEP_SUMMARY
          echo "flyctl status --app nuzantara-rag" >> $GITHUB_STEP_SUMMARY
          echo "flyctl logs --app nuzantara-rag" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Test tools visibility in webapp" >> $GITHUB_STEP_SUMMARY
          echo "2. Check console for tool usage logs" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify tool badges display in UI" >> $GITHUB_STEP_SUMMARY
