name: Test Automation CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  test-quality:
    name: Test Quality Check
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd apps/backend-rag
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio

    - name: Run Test Quality Checker
      run: |
        python3 scripts/test_automation/test_quality_checker.py
      continue-on-error: true

    - name: Upload Quality Report
      uses: actions/upload-artifact@v4
      with:
        name: test-quality-report
        path: test_quality_report.txt

  coverage-analysis:
    name: Coverage Analysis
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd apps/backend-rag
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio

    - name: Run Coverage Monitor
      run: |
        python3 scripts/test_automation/coverage_monitor.py 90
      continue-on-error: true

    - name: Upload Coverage Report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          coverage_report.txt
          apps/backend-rag/coverage.json

  auto-generate-tests:
    name: Auto-Generate Missing Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Check for untested modules
      run: |
        python3 scripts/test_automation/test_generator.py --dry-run

    - name: Create Issue if tests missing
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸ¤– Auto-Test Generation: Missing Tests Detected',
            body: 'The test generator found modules without tests. Run `python3 scripts/test_automation/test_generator.py` locally to generate test skeletons.',
            labels: ['testing', 'automation', 'needs-tests']
          })

  run-tests:
    name: Run Complete Test Suite
    runs-on: ubuntu-latest
    needs: [test-quality, coverage-analysis]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd apps/backend-rag
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio

    - name: Run Tests
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        DATABASE_URL: postgresql://test:test@localhost/test
        JWT_SECRET_KEY: test-secret-key-for-ci-must-be-at-least-32-chars-long
        QDRANT_URL: http://localhost:6333
      run: |
        cd apps/backend-rag
        pytest tests/unit -v --cov=backend --cov-config=.coveragerc --cov-report=term-missing --cov-report=xml

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./apps/backend-rag/coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Comment PR with Coverage
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const coverage = JSON.parse(fs.readFileSync('apps/backend-rag/coverage.json', 'utf8'));
          const totalCoverage = coverage.totals.percent_covered.toFixed(2);

          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `## ðŸ“Š Coverage Report\n\n**Total Coverage:** ${totalCoverage}%\n\nâœ… All tests passed!`
          })
