name: üîÑ Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - production
      target_version:
        description: 'Target version/commit SHA to rollback to (leave empty for previous deployment)'
        required: false
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
      confirmation:
        description: 'Type ROLLBACK to confirm'
        required: true
        type: string

env:
  NODE_VERSION: '20.x'
  FLY_APP_STAGING: nuzantara-staging
  FLY_APP_PRODUCTION: nuzantara-core
  REGISTRY: ghcr.io

jobs:
  # ==========================================
  # ‚úÖ VALIDATION
  # ==========================================

  validate-rollback:
    name: ‚úÖ Validate Rollback Request
    runs-on: ubuntu-latest
    outputs:
      confirmed: ${{ steps.validate.outputs.confirmed }}
      target_image: ${{ steps.validate.outputs.target_image }}
    steps:
      - name: üîê Confirm rollback
        id: validate
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "ROLLBACK" ]; then
            echo "‚ùå **Rollback cancelled:** Confirmation must be 'ROLLBACK'" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "## üö® Rollback Request" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Version:** ${{ github.event.inputs.target_version || 'Previous deployment' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Requested by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

          echo "confirmed=true" >> $GITHUB_OUTPUT

          # Determine target image
          if [ -n "${{ github.event.inputs.target_version }}" ]; then
            TARGET_IMAGE="prod-${{ github.event.inputs.target_version }}"
          else
            TARGET_IMAGE="production-latest"
          fi
          echo "target_image=$TARGET_IMAGE" >> $GITHUB_OUTPUT

      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìú Show recent deployments
        run: |
          echo "## üìú Recent Deployments" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git log --oneline -10 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # üíæ BACKUP CURRENT STATE
  # ==========================================

  backup-current-state:
    name: üíæ Backup Current State
    runs-on: ubuntu-latest
    needs: [validate-rollback]
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üíæ Save current deployment state
        run: |
          echo "## üíæ Current State Backup" >> $GITHUB_STEP_SUMMARY

          BACKUP_FILE="rollback-backup-$(date +%Y%m%d-%H%M%S).json"

          cat > $BACKUP_FILE <<EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "environment": "${{ github.event.inputs.environment }}",
            "current_commit": "${{ github.sha }}",
            "rollback_to": "${{ github.event.inputs.target_version }}",
            "reason": "${{ github.event.inputs.reason }}",
            "triggered_by": "${{ github.actor }}"
          }
          EOF

          echo "‚úÖ Backup saved: $BACKUP_FILE" >> $GITHUB_STEP_SUMMARY

      - name: üì¶ Upload backup
        uses: actions/upload-artifact@v4
        with:
          name: rollback-backup-${{ github.run_id }}
          path: rollback-backup-*.json
          retention-days: 90

  # ==========================================
  # üîÑ EXECUTE ROLLBACK
  # ==========================================

  execute-rollback:
    name: üîÑ Execute Rollback
    runs-on: ubuntu-latest
    needs: [validate-rollback, backup-current-state]
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: üîÑ Rollback deployment
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            FLY_APP="${{ env.FLY_APP_PRODUCTION }}"
          else
            FLY_APP="${{ env.FLY_APP_STAGING }}"
          fi

          echo "## üîÑ Rolling Back ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**App:** $FLY_APP" >> $GITHUB_STEP_SUMMARY

          # Get previous release
          if [ -n "${{ github.event.inputs.target_version }}" ]; then
            # Rollback to specific version
            TARGET_IMAGE="${{ env.REGISTRY }}/${{ github.repository }}/zantara-backend:${{ needs.validate-rollback.outputs.target_image }}"
            echo "**Rolling back to:** $TARGET_IMAGE" >> $GITHUB_STEP_SUMMARY

            flyctl deploy \
              --app $FLY_APP \
              --image $TARGET_IMAGE \
              --strategy immediate \
              --wait-timeout 300
          else
            # Rollback to previous deployment
            echo "**Rolling back to:** Previous deployment" >> $GITHUB_STEP_SUMMARY

            flyctl releases rollback \
              --app $FLY_APP \
              --yes
          fi

          echo "‚úÖ Rollback command executed" >> $GITHUB_STEP_SUMMARY

      - name: ‚è≥ Wait for rollback to stabilize
        run: sleep 30

  # ==========================================
  # üè• VERIFY ROLLBACK
  # ==========================================

  verify-rollback:
    name: üè• Verify Rollback Success
    runs-on: ubuntu-latest
    needs: [execute-rollback]
    steps:
      - name: üè• Health check after rollback
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            HEALTH_URL="https://${{ env.FLY_APP_PRODUCTION }}.fly.dev/health"
          else
            HEALTH_URL="https://${{ env.FLY_APP_STAGING }}.fly.dev/health"
          fi

          echo "## üè• Rollback Verification" >> $GITHUB_STEP_SUMMARY

          MAX_RETRIES=15
          RETRY_COUNT=0
          SUCCESS=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Health check passed (HTTP $HTTP_CODE) on attempt $((RETRY_COUNT + 1))" >> $GITHUB_STEP_SUMMARY
              SUCCESS=1
              break
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚è≥ Attempt $RETRY_COUNT/$MAX_RETRIES: HTTP $HTTP_CODE" >> $GITHUB_STEP_SUMMARY
            sleep 10
          done

          if [ $SUCCESS -eq 0 ]; then
            echo "‚ùå **Health check failed after rollback!**" >> $GITHUB_STEP_SUMMARY
            echo "üö® **CRITICAL: Manual intervention required immediately!**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: üß™ Run smoke tests
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            BASE_URL="https://${{ env.FLY_APP_PRODUCTION }}.fly.dev"
          else
            BASE_URL="https://${{ env.FLY_APP_STAGING }}.fly.dev"
          fi

          echo "## üß™ Post-Rollback Smoke Tests" >> $GITHUB_STEP_SUMMARY

          # Test critical endpoints
          ENDPOINTS=("/health" "/")
          FAILED=0

          for endpoint in "${ENDPOINTS[@]}"; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL$endpoint" || echo "000")
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "404" ]; then
              echo "‚úÖ $endpoint: HTTP $HTTP_CODE" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå $endpoint: HTTP $HTTP_CODE" >> $GITHUB_STEP_SUMMARY
              FAILED=1
            fi
          done

          if [ $FAILED -eq 1 ]; then
            echo "‚ö†Ô∏è Some endpoints failed smoke tests after rollback" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **All smoke tests passed**" >> $GITHUB_STEP_SUMMARY

  # ==========================================
  # üì¢ NOTIFICATIONS & INCIDENT REPORT
  # ==========================================

  notify-and-document:
    name: üì¢ Notify & Create Incident Report
    runs-on: ubuntu-latest
    needs: [validate-rollback, execute-rollback, verify-rollback]
    if: always()
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üìÑ Create incident report
        run: |
          INCIDENT_FILE="incidents/incident-$(date +%Y%m%d-%H%M%S).md"
          mkdir -p incidents

          cat > $INCIDENT_FILE <<EOF
          # Rollback Incident Report

          **Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Environment:** ${{ github.event.inputs.environment }}
          **Triggered by:** ${{ github.actor }}

          ## Details

          - **Reason:** ${{ github.event.inputs.reason }}
          - **Target Version:** ${{ github.event.inputs.target_version || 'Previous deployment' }}
          - **Current Commit (before rollback):** ${{ github.sha }}
          - **Rollback Status:** ${{ needs.verify-rollback.result }}

          ## Timeline

          1. **Rollback Initiated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          2. **Rollback Executed:** ${{ needs.execute-rollback.result }}
          3. **Verification:** ${{ needs.verify-rollback.result }}

          ## Post-Incident Actions Required

          - [ ] Root cause analysis
          - [ ] Fix underlying issue
          - [ ] Update tests to prevent recurrence
          - [ ] Document lessons learned
          - [ ] Schedule post-mortem meeting

          ## Notes

          ${{ github.event.inputs.reason }}
          EOF

          echo "## üìÑ Incident Report Created" >> $GITHUB_STEP_SUMMARY
          echo '```markdown' >> $GITHUB_STEP_SUMMARY
          cat $INCIDENT_FILE >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: üì¶ Save incident report
        uses: actions/upload-artifact@v4
        with:
          name: incident-report-${{ github.run_id }}
          path: incidents/*.md
          retention-days: 365

      - name: üì¢ Slack notification (success)
        if: needs.verify-rollback.result == 'success'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "üîÑ Rollback completed successfully",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*üîÑ ZANTARA Rollback Completed*\n\n*Environment:* ${{ github.event.inputs.environment }}\n*Reason:* ${{ github.event.inputs.reason }}\n*Triggered by:* ${{ github.actor }}\n*Status:* ‚úÖ Successful\n\n*Action Required:* Review incident report and schedule post-mortem"
                    }
                  }
                ]
              }' || echo "Slack webhook not configured"
          fi

      - name: üì¢ Slack notification (failure)
        if: needs.verify-rollback.result == 'failure'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "üö® CRITICAL: Rollback failed!",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*üö® CRITICAL: ZANTARA Rollback Failed*\n\n*Environment:* ${{ github.event.inputs.environment }}\n*Triggered by:* ${{ github.actor }}\n*Status:* ‚ùå Failed\n\n*üö® IMMEDIATE ACTION REQUIRED*\n*Manual intervention needed!*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View logs>"
                    }
                  }
                ]
              }' || echo "Slack webhook not configured"
          fi

      - name: üìä Final rollback summary
        if: always()
        run: |
          echo "---" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.verify-rollback.result }}" == "success" ]; then
            echo "# ‚úÖ Rollback Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. ‚úÖ Service is stable and running previous version" >> $GITHUB_STEP_SUMMARY
            echo "2. üîç Investigate root cause of issues" >> $GITHUB_STEP_SUMMARY
            echo "3. üõ†Ô∏è Fix issues in develop branch" >> $GITHUB_STEP_SUMMARY
            echo "4. üß™ Test thoroughly on staging" >> $GITHUB_STEP_SUMMARY
            echo "5. üìÖ Schedule post-mortem meeting" >> $GITHUB_STEP_SUMMARY
            echo "6. üìù Document lessons learned" >> $GITHUB_STEP_SUMMARY
          else
            echo "# ‚ùå Rollback Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## üö® CRITICAL ACTION REQUIRED" >> $GITHUB_STEP_SUMMARY
            echo "1. Contact on-call engineer immediately" >> $GITHUB_STEP_SUMMARY
            echo "2. Check Fly.io dashboard for errors" >> $GITHUB_STEP_SUMMARY
            echo "3. Review application logs" >> $GITHUB_STEP_SUMMARY
            echo "4. Consider manual intervention" >> $GITHUB_STEP_SUMMARY
            echo "5. Escalate to senior engineer if needed" >> $GITHUB_STEP_SUMMARY
          fi
