name: Deploy to Cloud Run via GitHub Actions

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PROJECT_ID: involuted-box-469105-r0
  REGION: europe-west1
  SERVICE: zantara-bridge-v3
  REGISTRY: gcr.io
  SERVICE_ACCOUNT: cloud-run-deployer@involuted-box-469105-r0.iam.gserviceaccount.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Run tests
      run: npm test
      continue-on-error: true

    - name: Run linting
      run: npm run lint
      continue-on-error: true

    - name: Build TypeScript
      run: npm run build
      continue-on-error: true

    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configure Docker for GCR
      run: gcloud auth configure-docker

    - name: Build Docker image
      run: |
        docker build -f Dockerfile.dist -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE }}:${{ github.sha }} .
        docker tag ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE }}:latest

    - name: Push Docker image
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE }}:latest

    - name: Deploy to Cloud Run
      id: deploy
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        service: ${{ env.SERVICE }}
        region: ${{ env.REGION }}
        image: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.SERVICE }}:${{ github.sha }}
        flags: |
          --allow-unauthenticated
          --service-account=${{ env.SERVICE_ACCOUNT }}
          --memory=2Gi
          --cpu=2
          --concurrency=1000
          --timeout=3600
          --min-instances=0
          --max-instances=10
          --clear-secrets
        env_vars: |
          NODE_ENV=production
          GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}
          REGION=${{ env.REGION }}
          CORS_ORIGINS=*.balizero.com
          USE_AI_SUMMARY=true
          FIRESTORE_PROJECT_ID=involuted-box-469105-r0
          API_KEYS_INTERNAL=zantara-internal-dev-key-2025
          API_KEYS_EXTERNAL=zantara-external-dev-key-2025

    - name: Show deployed URL
      run: echo "Deployed to ${{ steps.deploy.outputs.url }}"

    - name: Health check
      run: |
        sleep 30
        curl -f ${{ steps.deploy.outputs.url }}/health || exit 1

    - name: Run post-deployment tests
      run: |
        export SERVICE_URL="${{ steps.deploy.outputs.url }}"
        ./scripts/smoke-basic.sh || true