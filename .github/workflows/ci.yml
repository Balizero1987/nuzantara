name: ðŸš€ ZANTARA CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to production'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18.x'
  REGISTRY: ghcr.io
  FLY_APP: nuzantara-core

jobs:
  # ==========================================
  # ðŸ” QUALITY CHECKS
  # ==========================================
  
  lint:
    name: ðŸ” Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run ESLint
        run: npm run lint || echo "âš ï¸ ESLint warnings found (non-blocking)"

  typecheck:
    name: ðŸ“ TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: âœ… Type check
        run: npm run typecheck

  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”’ Run security audit
        run: npm run security:audit
        continue-on-error: true

  # ==========================================
  # ðŸ§ª TESTING
  # ==========================================
  
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: [typecheck]
    continue-on-error: true
    strategy:
      matrix:
        workspace: [backend-ts]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ§ª Run tests
        run: npm run test:ci
        env:
          CI: true
          NODE_ENV: test
        continue-on-error: true

      - name: ðŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  test-coverage:
    name: ðŸ“Š Test Coverage Report
    runs-on: ubuntu-latest
    needs: [test]
    if: always()
    continue-on-error: true
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ“Š Generate coverage report
        run: npm run test:coverage

      - name: ðŸ“ˆ Comment coverage PR
        uses: romeovs/lcov-reporter-action@v0.3.1
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          lcov-file: ./coverage/lcov.info

  # ==========================================
  # ðŸ—ï¸ BUILD VALIDATION
  # ==========================================
  
  build-backend-ts:
    name: ðŸ—ï¸ Build Backend TypeScript
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    if: always() && needs.typecheck.result == 'success'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build TypeScript
        run: npm run build
        working-directory: apps/backend-ts

      - name: âœ… Verify build output
        run: |
          if [ ! -f "apps/backend-ts/dist/server.js" ]; then
            echo "âŒ Build failed: dist/server.js not found"
            exit 1
          fi
          echo "âœ… Build successful"

      - name: ðŸ“¦ Save build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-ts-build
          path: apps/backend-ts/dist/
          retention-days: 7

  # ==========================================
  # ðŸ³ DOCKER BUILD
  # ==========================================
  
  docker-build:
    name: ðŸ³ Validate Docker Build
    runs-on: ubuntu-latest
    needs: [build-backend-ts]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Validate Docker build
        uses: docker/build-push-action@v5
        with:
          context: ./apps/backend-ts
          file: ./apps/backend-ts/Dockerfile
          push: false
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/backend-ts:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: âœ… Docker build validation passed
        run: echo "âœ… Docker image builds successfully"

  # ==========================================
  # ðŸš€ DEPLOYMENT
  # ==========================================
  
  deploy-production:
    name: ðŸš€ Deploy to Production (Fly.io)
    runs-on: ubuntu-latest
    needs: [build-backend-ts, docker-build]
    if: |
      (needs.build-backend-ts.result == 'success' && needs.docker-build.result == 'success') &&
      ((github.ref == 'refs/heads/main' && github.event_name == 'push') ||
       (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true'))
    environment:
      name: production
      url: https://${{ env.FLY_APP }}.fly.dev
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Install Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: ðŸ” Setup Fly.io credentials
        run: |
          echo "${{ secrets.FLY_API_TOKEN }}" | flyctl auth login --stdin

      - name: ðŸš€ Deploy to Fly.io
        working-directory: ./apps/backend-ts
        run: |
          flyctl deploy \
            --app ${{ env.FLY_APP }} \
            --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: ðŸ¥ Health check
        run: |
          echo "â³ Waiting for deployment to stabilize..."
          sleep 30
          
          HEALTH_URL="https://${{ env.FLY_APP }}.fly.dev/health"
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Health check failed (HTTP $HTTP_CODE). Retry $RETRY_COUNT/$MAX_RETRIES..."
            sleep 10
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES retries"
          exit 1

      - name: ðŸ“¢ Notify deployment
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!"
            echo "ðŸŒ App URL: https://${{ env.FLY_APP }}.fly.dev"
          else
            echo "âŒ Deployment failed!"
          fi

  # ==========================================
  # ðŸ“Š PIPELINE SUMMARY
  # ==========================================
  
  pipeline-summary:
    name: ðŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [lint, typecheck, security-audit, test, build-backend-ts, docker-build]
    if: always()
    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "## ðŸš€ ZANTARA CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ TypeCheck | ${{ needs.typecheck.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security Audit | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build | ${{ needs.build-backend-ts.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Docker Build | ${{ needs.docker-build.result }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.docker-build.result }}" != "skipped" ]; then
            echo "| ðŸš€ Deploy | ${{ needs.deploy-production.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-production.result }}" == "success" ] || [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "âœ… **All checks passed! Deployment successful.**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ **Production URL:** https://${{ env.FLY_APP }}.fly.dev" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Some checks failed. Please review the logs.**" >> $GITHUB_STEP_SUMMARY
          fi

