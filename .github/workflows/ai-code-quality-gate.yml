# ============================================================================
# AI CODE QUALITY GATE - CI/CD Workflow
# ============================================================================
#
# Questo workflow implementa quality gates rigorosi per ogni PR e push.
# Tutti i check sono BLOCKING - il merge Ã¨ impossibile se falliscono.
#
# LAYERS:
# 1. AI Code Validator (architectural coherence, security, harmony)
# 2. TypeScript/JavaScript quality (types, lint, format)
# 3. Python quality (types, lint, format, security)
# 4. Testing (unit, integration, e2e, coverage >=70%)
# 5. Security scanning (secrets, vulnerabilities, SAST)
# 6. Performance checks (bundle size, benchmarks)
# 7. Breaking changes detection
#
# ============================================================================

name: ðŸ¤– AI Code Quality Gate

on:
  push:
    branches:
      - main
      - staging
      - 'claude/**'
  pull_request:
    types: [opened, synchronize, reopened]

# Cancel in-progress runs for same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.10'

jobs:

  # ==========================================================================
  # JOB 1: AI CODE VALIDATOR (GATEKEEPER)
  # ==========================================================================
  ai-validation:
    name: ðŸ§  AI Code Validator
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install AI validator dependencies
        working-directory: .ai-code-quality
        run: npm install

      - name: ðŸ§  Run AI Code Validator
        working-directory: .ai-code-quality
        run: npx ts-node ai-code-validator.ts

      - name: ðŸ“Š Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-validation-report
          path: .ai-code-quality/reports/latest.json
          retention-days: 30

      - name: ðŸ’¬ Comment validation results on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('.ai-code-quality/reports/latest.json', 'utf8'));

            const body = `## ðŸ¤– AI Code Quality Gate - FAILED

            **Critical Issues:** ${report.summary.critical_issues}
            **Violations:** ${report.summary.violations_count}
            **Warnings:** ${report.summary.warnings_count}

            ### ðŸš¨ Violations

            ${report.violations.map((v, i) => `
            **${i + 1}. ${v.rule_name}** [\`${v.severity}\`]
            - **File:** \`${v.file}\`
            - **Message:** ${v.message}
            ${v.suggestion ? `- **ðŸ’¡ Suggestion:** ${v.suggestion}` : ''}
            `).join('\n')}

            ---
            ðŸ” [View full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ==========================================================================
  # JOB 2: TYPESCRIPT QUALITY
  # ==========================================================================
  typescript-quality:
    name: ðŸ“ TypeScript Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: ai-validation  # Only run after AI validation passes

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” ESLint (BLOCKING)
        run: npm run lint

      - name: ðŸ’… Prettier check (BLOCKING)
        run: npx prettier --check "**/*.{ts,tsx,js,jsx,json,yaml,yml,md}"

      - name: ðŸ“˜ TypeScript type check (STRICT)
        run: npm run typecheck

      - name: ðŸ“Š Check for unused exports
        run: npx ts-prune | tee ts-prune-output.txt && [ ! -s ts-prune-output.txt ]
        continue-on-error: true

  # ==========================================================================
  # JOB 3: PYTHON QUALITY
  # ==========================================================================
  python-quality:
    name: ðŸ Python Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: ai-validation

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Install Python dependencies
        working-directory: apps/backend-rag
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install black isort ruff mypy bandit pytest pytest-cov

      - name: ðŸ–¤ Black formatting check (BLOCKING)
        working-directory: apps/backend-rag
        run: python -m black --check --diff .

      - name: ðŸ“‹ isort import check (BLOCKING)
        working-directory: apps/backend-rag
        run: python -m isort --check-only --diff .

      - name: âš¡ Ruff linting (BLOCKING)
        working-directory: apps/backend-rag
        run: python -m ruff check .

      - name: ðŸ”’ Mypy type checking (STRICT)
        working-directory: apps/backend-rag
        run: python -m mypy . --ignore-missing-imports --strict

      - name: ðŸ” Bandit security check (BLOCKING)
        working-directory: apps/backend-rag
        run: python -m bandit -r . -f json -o bandit-report.json || true

      - name: ðŸ“Š Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: apps/backend-rag/bandit-report.json
          retention-days: 30

  # ==========================================================================
  # JOB 4: TESTING (STRICT COVERAGE)
  # ==========================================================================
  testing:
    name: ðŸ§ª Testing & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [typescript-quality, python-quality]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci
          cd apps/backend-rag && pip install -r requirements.txt && pip install pytest pytest-cov

      - name: ðŸ§ª TypeScript tests with coverage (MUST PASS)
        run: npm run test:coverage
        env:
          CI: true

      - name: ðŸ§ª Python tests with coverage (MUST PASS)
        working-directory: apps/backend-rag
        run: python -m pytest tests/ --cov=. --cov-report=xml --cov-report=term --cov-fail-under=70

      - name: ðŸ“Š Upload TypeScript coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: typescript
          name: typescript-coverage
          fail_ci_if_error: true

      - name: ðŸ“Š Upload Python coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./apps/backend-rag/coverage.xml
          flags: python
          name: python-coverage
          fail_ci_if_error: true

  # ==========================================================================
  # JOB 5: SECURITY SCANNING
  # ==========================================================================
  security:
    name: ðŸ” Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: ai-validation

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ” Detect secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

      - name: ðŸ” NPM security audit (HIGH/CRITICAL)
        run: npm audit --audit-level=high --production
        continue-on-error: false

      - name: ðŸ Python security audit (pip-audit)
        run: |
          pip install pip-audit
          cd apps/backend-rag && pip-audit
        continue-on-error: true

      - name: ðŸ³ Docker image vulnerability scan (Trivy)
        if: hashFiles('Dockerfile') != ''
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: ðŸ“Š Upload Trivy results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # ==========================================================================
  # JOB 6: PERFORMANCE CHECKS
  # ==========================================================================
  performance:
    name: âš¡ Performance Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: testing

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ“¦ Build TypeScript
        run: npm run build
        continue-on-error: true

      - name: ðŸ“Š Check bundle size
        run: |
          if [ -d "dist" ]; then
            BUNDLE_SIZE=$(du -sk dist | cut -f1)
            MAX_SIZE=2048  # 2MB in KB
            echo "Bundle size: ${BUNDLE_SIZE}KB (max: ${MAX_SIZE}KB)"

            if [ $BUNDLE_SIZE -gt $MAX_SIZE ]; then
              echo "âŒ Bundle size exceeds limit!"
              exit 1
            fi
          fi

  # ==========================================================================
  # JOB 7: BREAKING CHANGES DETECTION
  # ==========================================================================
  breaking-changes:
    name: ðŸ’¥ Breaking Changes Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'

    steps:
      - name: ðŸ“¥ Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Check for removed exports in shared package
        run: |
          # Check if shared package changed
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "packages/shared/"; then
            echo "âš ï¸  Shared package modified - checking for breaking changes..."

            # Get diff of exported symbols
            git diff origin/${{ github.base_ref }}...HEAD packages/shared/ | grep "^-export" > removed_exports.txt || true

            if [ -s removed_exports.txt ]; then
              echo "âŒ BREAKING CHANGE DETECTED!"
              echo "Removed exports found:"
              cat removed_exports.txt
              exit 1
            else
              echo "âœ… No breaking changes detected"
            fi
          fi

      - name: ðŸ” Check for API endpoint changes
        run: |
          # Check if route files changed
          CHANGED_ROUTES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "(routes|controllers)" || true)

          if [ -n "$CHANGED_ROUTES" ]; then
            echo "âš ï¸  API routes modified:"
            echo "$CHANGED_ROUTES"
            echo ""
            echo "âš ï¸  Please ensure no breaking API changes were made!"
            echo "If breaking changes are necessary, bump the major version."
          fi

  # ==========================================================================
  # JOB 8: QUALITY GATE SUMMARY
  # ==========================================================================
  quality-gate-summary:
    name: ðŸ“Š Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [ai-validation, typescript-quality, python-quality, testing, security, performance]
    if: always()

    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "# ðŸ¤– AI Code Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| AI Validation | ${{ needs.ai-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript Quality | ${{ needs.typescript-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Quality | ${{ needs.python-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Testing | ${{ needs.testing.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ needs.performance.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all passed
          if [ "${{ needs.ai-validation.result }}" = "success" ] && \
             [ "${{ needs.typescript-quality.result }}" = "success" ] && \
             [ "${{ needs.python-quality.result }}" = "success" ] && \
             [ "${{ needs.testing.result }}" = "success" ] && \
             [ "${{ needs.security.result }}" = "success" ] && \
             [ "${{ needs.performance.result }}" = "success" ]; then
            echo "## âœ… ALL QUALITY GATES PASSED" >> $GITHUB_STEP_SUMMARY
            echo "Code is ready to merge!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ QUALITY GATES FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Fix the failing checks before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: âœ… All checks passed
        run: echo "All quality gates passed successfully!"
