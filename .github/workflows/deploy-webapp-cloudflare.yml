name: Deploy Webapp to Cloudflare Pages

on:
  push:
    branches:
      - main
    paths:
      - 'website/zantara webapp/**'
      - '.github/workflows/deploy-webapp-cloudflare.yml'
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare webapp files
        run: |
          echo "üì¶ Preparing webapp files for Cloudflare Pages..."

          # Create deployment directory
          mkdir -p _deploy

          # Copy webapp files (ZANTARA Bali Zero theme)
          cp -r "website/zantara webapp/"* _deploy/

          # Create .nojekyll to ensure all files are served
          touch _deploy/.nojekyll

          # Add deployment timestamp
          echo "<!-- Deployed: $(date -u +"%Y-%m-%d %H:%M:%S UTC") -->" >> _deploy/login.html || true
          echo "<!-- Source: https://github.com/${{ github.repository }}/commit/${GITHUB_SHA} -->" >> _deploy/login.html || true
          echo "<!-- Platform: Cloudflare Pages -->" >> _deploy/login.html || true

          # List files being deployed (verification)
          echo "üìã Files to be deployed:"
          find _deploy -type f -name "*.html" -o -name "*.js" -o -name "*.css" | head -20

          # Verify critical files exist
          echo "‚úÖ Verifying critical files..."
          test -f _deploy/login.html && echo "  ‚úì login.html"
          test -f _deploy/chat.html && echo "  ‚úì chat.html"
          test -f _deploy/js/zantara-api.js && echo "  ‚úì zantara-api.js"
          test -f _deploy/js/api-contracts.js && echo "  ‚úì api-contracts.js"
          test -f _deploy/js/sse-client.js && echo "  ‚úì sse-client.js"
          test -f _deploy/tokens.css && echo "  ‚úì tokens.css"

          echo "üéâ Preparation complete!"

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        with:
          wranglerVersion: "4.45.0"
          command: pages deploy _deploy --project-name zantara-webapp --branch main

      - name: Deployment summary
        run: |
          echo "## üöÄ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** Cloudflare Pages" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** zantara-webapp" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** \`website/zantara webapp/\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** [\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${GITHUB_SHA})" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Live URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- üåê Production: https://zantara.balizero.com/" >> $GITHUB_STEP_SUMMARY
          echo "- üîó Cloudflare: https://zantara-webapp.pages.dev/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Features deployed:**" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ ZANTARA Bali Zero Theme" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Team Login + PIN Auth" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ SSE Streaming Chat" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ API Contracts (automatic fallback)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Citations Module" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Smart Suggestions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Verify deployment:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "curl -I https://zantara.balizero.com/" >> $GITHUB_STEP_SUMMARY
          echo "# Check for: cf-ray header (confirms Cloudflare)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Performance Benefits:**" >> $GITHUB_STEP_SUMMARY
          echo "- üöÄ 300+ global edge locations" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ö° ~50-100ms latency (vs 150-300ms GitHub Pages)" >> $GITHUB_STEP_SUMMARY
          echo "- üîí Automatic HTTPS" >> $GITHUB_STEP_SUMMARY
          echo "- üìä Built-in analytics" >> $GITHUB_STEP_SUMMARY

      - name: Wait and verify
        run: |
          echo "‚è≥ Waiting 30 seconds for CDN propagation..."
          sleep 30

          echo "üîç Verifying deployment..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://zantara-webapp.pages.dev/)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Cloudflare Pages deployment is live (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Deployment may still be propagating (HTTP $HTTP_CODE)"
            echo "   Check: https://dash.cloudflare.com ‚Üí Workers & Pages ‚Üí zantara-webapp"
          fi
