#!/usr/bin/env sh

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘        ğŸ¤– AI CODE QUALITY GATE - Pre-Push Validation              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ============================================================================
# LAYER 1: AI CODE VALIDATOR (GATEKEEPER)
# ============================================================================
echo "ğŸ§  [1/5] Running AI Code Validator..."
echo "      (Validates architectural coherence, security, and harmony)"
cd .ai-code-quality && npm install --silent 2>/dev/null || true
npx ts-node ai-code-validator.ts
AI_VALIDATION_EXIT=$?
cd ..

if [ $AI_VALIDATION_EXIT -ne 0 ]; then
  echo ""
  echo "âŒ AI Code Validator BLOCKED the push!"
  echo "   Fix the violations above before pushing."
  echo ""
  exit 1
fi

echo "   âœ… AI validation passed"
echo ""

# ============================================================================
# LAYER 2: TYPESCRIPT TYPE CHECKING (STRICT)
# ============================================================================
echo "ğŸ“ [2/5] Running TypeScript type checking..."
npm run typecheck

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ TypeScript type check FAILED!"
  echo "   Fix type errors before pushing."
  echo ""
  exit 1
fi

echo "   âœ… Type check passed"
echo ""

# ============================================================================
# LAYER 3: LINTING (BLOCKING)
# ============================================================================
echo "ğŸ” [3/5] Running ESLint..."
npm run lint

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ ESLint FAILED!"
  echo "   Fix linting errors before pushing."
  echo ""
  exit 1
fi

echo "   âœ… Lint check passed"
echo ""

# ============================================================================
# LAYER 4: TEST COVERAGE (STRICT BLOCKING)
# ============================================================================
echo "ğŸ§ª [4/5] Running test suite with coverage..."
npm run test:coverage

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Tests FAILED or coverage below threshold!"
  echo "   All tests must pass and coverage must be >= 70%"
  echo ""
  exit 1
fi

echo "   âœ… All tests passed with coverage"
echo ""

# ============================================================================
# LAYER 5: PYTHON QUALITY (if Python files changed)
# ============================================================================
PYTHON_FILES_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -n "$PYTHON_FILES_CHANGED" ]; then
  echo "ğŸ [5/5] Running Python quality checks..."

  # Check if we're in backend-rag directory
  if [ -d "apps/backend-rag" ]; then
    cd apps/backend-rag

    echo "      - Black (formatter)"
    python -m black --check . || {
      echo "âŒ Black formatting failed! Run: black ."
      exit 1
    }

    echo "      - Ruff (linter)"
    python -m ruff check . || {
      echo "âŒ Ruff linting failed! Run: ruff check . --fix"
      exit 1
    }

    echo "      - Mypy (type checker)"
    python -m mypy . --ignore-missing-imports || {
      echo "âŒ Mypy type checking failed!"
      exit 1
    }

    echo "      - Pytest (tests)"
    python -m pytest tests/ --cov=. --cov-fail-under=70 || {
      echo "âŒ Python tests failed or coverage below 70%!"
      exit 1
    }

    cd ../..
  fi

  echo "   âœ… Python quality checks passed"
  echo ""
else
  echo "ğŸ [5/5] No Python files changed, skipping Python checks"
  echo ""
fi

# ============================================================================
# SUCCESS
# ============================================================================
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   âœ… ALL QUALITY GATES PASSED - Code is ready to push!            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
