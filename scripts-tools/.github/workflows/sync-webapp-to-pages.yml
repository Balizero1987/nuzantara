name: Sync Webapp to GitHub Pages

on:
  push:
    branches: [main]
    paths:
      - 'apps/webapp/**'
      - 'static/zantara-production.html'
      - '.github/workflows/sync-webapp-to-pages.yml'
  workflow_dispatch:

env:
  TARGET_REPO: Balizero1987/zantara_webapp
  TARGET_BRANCH: main

jobs:
  sync-to-pages:
    name: Sync Webapp to GitHub Pages Repo
    runs-on: ubuntu-latest

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git identity
        run: |
          git config --global user.name "ZANTARA Auto-Sync"
          git config --global user.email "noreply@zantara.balizero.com"

      - name: Clone target repository
        env:
          GH_TOKEN: ${{ secrets.WEBAPP_DEPLOY_TOKEN }}
        run: |
          git clone https://x-access-token:${GH_TOKEN}@github.com/${TARGET_REPO}.git webapp-pages
          cd webapp-pages
          git checkout ${TARGET_BRANCH}

      - name: Sync webapp files
        run: |
          # Clear target (except .git)
          cd webapp-pages
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          # Copy webapp files from monorepo
          cp -r ../apps/webapp/* .

          # Add deployment timestamp to index.html
          echo "<!-- Deployed: $(date -u +"%Y-%m-%d %H:%M:%S UTC") -->" >> index.html
          echo "<!-- Source: https://github.com/Balizero1987/nuzantara/commit/${GITHUB_SHA} -->" >> index.html

      - name: Generate env.js (API base)
        run: |
          cd webapp-pages
          mkdir -p js
          TS_BASE="https://zantara-v520-nuzantara-himaadsxua-ew.a.run.app"
          echo "window.ZANTARA_PROXY_BASE='${TS_BASE}';" > js/env.js

      - name: Check for changes
        id: check_changes
        run: |
          cd webapp-pages
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to sync"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.WEBAPP_DEPLOY_TOKEN }}
        run: |
          cd webapp-pages
          git add .

          # Create commit message with source details
          COMMIT_MSG="sync: from monorepo @ $(date -u +"%Y-%m-%d %H:%M UTC")

          Source commit: ${GITHUB_SHA:0:7}
          Triggered by: ${{ github.event_name }}

          ðŸ¤– Auto-synced by GitHub Actions"

          git commit -m "$COMMIT_MSG"
          git push https://x-access-token:${GH_TOKEN}@github.com/${TARGET_REPO}.git ${TARGET_BRANCH}

          echo "âœ… Pushed to ${TARGET_REPO}"

      - name: Wait for GitHub Pages deployment
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "â³ GitHub Pages will deploy in 2-3 minutes"
          echo "ðŸ“ Live URL: https://zantara.balizero.com/"
          sleep 10

      - name: Verify deployment
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ðŸ” Verifying deployment..."

          # Wait max 3 minutes for deployment
          for i in {1..18}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://zantara.balizero.com/)
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… GitHub Pages is live (HTTP $HTTP_CODE)"

              # Check if our commit marker is present
              TIMESTAMP=$(curl -s https://zantara.balizero.com/ | grep -o "Deployed: [0-9-]* [0-9:]* UTC" | head -1)
              if [ -n "$TIMESTAMP" ]; then
                echo "âœ… Deployment verified: $TIMESTAMP"
              fi
              break
            fi
            echo "â³ Waiting for deployment... ($i/18)"
            sleep 10
          done

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ… **Status**: Webapp synced successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **Live URL**: https://zantara.balizero.com/" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **Source**: [\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${GITHUB_SHA})" >> $GITHUB_STEP_SUMMARY
            echo "â±ï¸ **Deployed**: $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Status**: No changes to sync" >> $GITHUB_STEP_SUMMARY
          fi
