<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZANTARA - Login</title>
  
  <style>
    /**
     * ZANTARA Login - Exact from React source
     */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      background: #2B2B2B !important;
      background-color: #2B2B2B !important;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
    }

    body {
      display: flex;
      align-items: flex-start; /* Allinea in alto invece di center */
      justify-content: center;
      padding: 0.5rem 2rem; /* Ridotto ancora di più padding dall'alto */
      padding-top: 1rem; /* Ancora meno spazio dall'alto */
    }

    /* Login Container - Form più in alto */
    .login-container {
      width: 100%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem; /* Gap aumentato per separare logo e form */
      margin-top: -2rem; /* Sposta tutto più in alto */
    }

    /* Logo - Spostato più in basso con margini negativi */
    .bali-zero-logo {
      width: 450px; /* Ingrandito ulteriormente */
      height: auto;
      max-width: 450px;
      display: block;
      margin: 2rem auto 0 auto; /* Margin-top aumentato per spostarlo più in basso */
      margin-bottom: -1rem; /* Margine negativo per avvicinare visivamente */
    }

    /* Form rettangolare verticale elegante in altorilievo - Spostato più in alto */
    .login-form-wrapper {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: -3rem; /* Margine negativo per spostare il form più in alto */
    }

    .login-form {
      background: rgba(70, 70, 70, 0.75) !important; /* Più chiaro e più trasparente */
      backdrop-filter: blur(12px) !important; /* Blur più intenso */
      -webkit-backdrop-filter: blur(12px) !important; /* Supporto Safari */
      border: 1px solid rgba(255, 255, 255, 0.15) !important; /* Bordo più visibile */
      border-radius: 8px; /* Angoli leggermente arrotondati */
      padding: 3rem 2.5rem;
      width: 100%;
      max-width: 380px;
      box-sizing: border-box;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 
                  0 2px 8px rgba(0, 0, 0, 0.2),
                  inset 0 1px 0 rgba(255, 255, 255, 0.05); /* Ombre eleganti */
      transform: translateY(-2px);
      transition: box-shadow 0.3s ease, transform 0.3s ease;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    /* Form elements eleganti */
    .form-label {
      color: rgba(255, 255, 255, 0.9);
      display: block;
      margin-bottom: 0.75rem;
      font-weight: 500;
      font-size: 0.875rem;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .form-input {
      background: #ffffff !important; /* Bianco */
      border: 1px solid #3a3a3a !important;
      color: #000000 !important; /* Testo nero per leggibilità su bianco */
      padding: 0.875rem 1rem;
      width: 100%;
      box-sizing: border-box;
      font-size: 1rem;
      transition: all 0.2s ease;
      border-radius: 0;
    }

    .form-input:focus {
      outline: none;
      background: #ffffff !important;
      border-color: rgba(217, 32, 39, 0.8);
      color: #000000 !important;
      border-bottom: 2px solid rgba(217, 32, 39, 0.8) !important;
    }

    .form-input::placeholder {
      color: #999 !important; /* Grigio scuro per placeholder su bianco */
    }

    /* PIN OTP Input - 6 slots */
    .pin-otp-wrapper {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .pin-otp-slot {
      width: 2.1rem; /* 3rem * 0.7 = 2.1rem - 30% più piccolo */
      height: 2.45rem; /* 3.5rem * 0.7 = 2.45rem - 30% più piccolo */
      background: #ffffff !important; /* Bianco */
      border: 1px solid #3a3a3a !important;
      color: #000000 !important; /* Testo nero */
      font-size: 1.05rem; /* 1.5rem * 0.7 = 1.05rem - proporzionale */
      font-weight: 600;
      text-align: center;
      transition: all 0.2s ease;
      border-radius: 0;
      outline: none;
    }

    .pin-otp-slot:focus {
      background: #ffffff !important;
      border-color: rgba(217, 32, 39, 0.8);
      border-bottom: 2px solid rgba(217, 32, 39, 0.8) !important;
    }

    .pin-otp-slot.filled {
      background: #ffffff !important;
      border-color: rgba(217, 32, 39, 0.6);
    }

    .pin-hint {
      font-size: 0.65rem !important;
      color: rgba(255, 255, 255, 0.4);
      margin-top: 0.5rem;
      text-align: center;
    }

    /* Login Button */
    .login-button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(217, 32, 39, 0.5) !important;
      border-top: 1px solid rgba(255, 255, 255, 0.05) !important;
      color: rgba(255, 255, 255, 0.95);
      padding: 0.875rem 2rem;
      width: 100%;
      font-weight: 500;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 1.5rem;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .login-button:hover:not(:disabled) {
      background: rgba(217, 32, 39, 0.9) !important;
      border-color: rgba(217, 32, 39, 0.9) !important;
      border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
      color: rgba(255, 255, 255, 1) !important;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .login-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .login-button.loading {
      position: relative;
    }

    .button-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-left: 0.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Messages */
    .error-message,
    .welcome-message {
      padding: 0.875rem 1rem;
      margin-top: 1rem;
      border-radius: 4px;
      font-size: 0.875rem;
      text-align: center;
      animation: slideIn 0.3s ease;
    }

    .error-message {
      background: rgba(217, 32, 39, 0.15);
      border: 1px solid rgba(217, 32, 39, 0.3);
      color: rgba(255, 100, 100, 0.95);
    }

    .welcome-message.success {
      background: rgba(76, 175, 80, 0.15);
      border: 1px solid rgba(76, 175, 80, 0.3);
      color: rgba(139, 195, 74, 0.95);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <img 
      src="/assets/logo1-zantara-Bxg9_l5o.svg" 
      alt="ZANTARA" 
      class="bali-zero-logo"
      onerror="this.style.display='none'"
    />
    
    <div class="login-form-wrapper">
      <div id="welcomeMessage"></div>

      <form id="loginForm" class="login-form">
        <div id="ariaLive" class="sr-only" aria-live="polite" aria-atomic="true"></div>
        
        <!-- Email Field -->
        <div class="form-group">
          <label for="email" class="form-label">Email Address</label>
          <input
            type="email"
            id="email"
            class="form-input"
            placeholder="your.email@example.com"
            autocomplete="email"
            required
          />
        </div>

        <!-- PIN Field - 6 digits -->
        <div class="form-group">
          <label class="form-label">Security PIN</label>
          <div class="pin-otp-wrapper" id="pinWrapper">
            <input type="text" class="pin-otp-slot" maxlength="1" inputmode="numeric" data-index="0" />
            <input type="text" class="pin-otp-slot" maxlength="1" inputmode="numeric" data-index="1" />
            <input type="text" class="pin-otp-slot" maxlength="1" inputmode="numeric" data-index="2" />
            <input type="text" class="pin-otp-slot" maxlength="1" inputmode="numeric" data-index="3" />
            <input type="text" class="pin-otp-slot" maxlength="1" inputmode="numeric" data-index="4" />
            <input type="text" class="pin-otp-slot" maxlength="1" inputmode="numeric" data-index="5" />
          </div>
          <div class="pin-hint">Enter your 6-digit PIN</div>
        </div>

        <button 
          type="submit" 
          id="loginButton" 
          class="login-button"
          disabled
        >
          <span class="button-text">SIGN IN</span>
        </button>

        <div id="errorMessage"></div>
      </form>
    </div>
  </div>

  <script>
    // API Configuration
    const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const API_BASE_URL = isDevelopment ? 'http://localhost:8000' : 'https://nuzantara-rag.fly.dev';

    // Elements
    const emailInput = document.getElementById('email');
    const pinInputs = document.querySelectorAll('.pin-otp-slot');
    const loginButton = document.getElementById('loginButton');
    const errorMessageEl = document.getElementById('errorMessage');
    const welcomeMessageEl = document.getElementById('welcomeMessage');
    const ariaLive = document.getElementById('ariaLive');
    const loginForm = document.getElementById('loginForm');

    // State
    let email = '';
    let pin = '';
    let emailValid = null;
    let pinValid = null;
    let loading = false;

    // Validation functions (from login-utils.ts)
    function validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function sanitizePin(pin) {
      return pin.replace(/\D/g, '');
    }

    function validatePin(pin) {
      const sanitized = sanitizePin(pin);
      const length = sanitized.length;
      const isValid = length >= 4 && length <= 8;
      return { isValid, length };
    }

    // UI Updates
    function updateAriaLive() {
      let message = '';
      if (emailValid === true) message += 'Email format valid. ';
      if (emailValid === false) message += 'Email format invalid. ';
      if (pin.length > 0) {
        const validation = validatePin(pin);
        message += `${validation.length} digits entered. `;
        if (validation.isValid) message += 'PIN valid. ';
      }
      ariaLive.textContent = message;
    }

    function updateSubmitButton() {
      const validation = validatePin(pin);
      loginButton.disabled = !(emailValid && validation.isValid) || loading;
    }

    function showError(text) {
      errorMessageEl.innerHTML = `<div class="error-message show" role="alert">${text}</div>`;
    }

    function clearError() {
      errorMessageEl.innerHTML = '';
    }

    function showSuccess(text) {
      welcomeMessageEl.innerHTML = `<div class="welcome-message show success">${text}</div>`;
    }

    function clearSuccess() {
      welcomeMessageEl.innerHTML = '';
    }

    // Email input handling
    emailInput.addEventListener('input', (e) => {
      email = e.target.value.trim();
      
      if (email.length === 0) {
        emailValid = null;
      } else {
        emailValid = validateEmail(email);
      }
      
      if (email.length > 0) {
        clearError();
      }
      
      updateAriaLive();
      updateSubmitButton();
    });

    emailInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        pinInputs[0].focus();
      }
    });

    // PIN input handling
    pinInputs.forEach((input, index) => {
      input.addEventListener('input', (e) => {
        const value = e.target.value;
        
        // Sanitize
        const sanitized = value.replace(/\D/g, '');
        if (sanitized !== value) {
          e.target.value = sanitized;
        }

        if (sanitized) {
          input.classList.add('filled');
          // Auto-focus next
          if (index < 5) {
            pinInputs[index + 1].focus();
          }
        } else {
          input.classList.remove('filled');
        }

        updatePin();
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
          pinInputs[index - 1].focus();
          pinInputs[index - 1].value = '';
          pinInputs[index - 1].classList.remove('filled');
          updatePin();
        }
      });

      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
        
        pastedData.split('').forEach((char, i) => {
          if (pinInputs[i]) {
            pinInputs[i].value = char;
            pinInputs[i].classList.add('filled');
          }
        });
        
        updatePin();
        if (pastedData.length >= 4) {
          const lastIndex = Math.min(pastedData.length - 1, 5);
          pinInputs[lastIndex].focus();
        }
      });
    });

    function updatePin() {
      pin = Array.from(pinInputs).map(input => input.value).join('');
      const validation = validatePin(pin);
      pinValid = validation.isValid;
      
      if (validation.length > 0) {
        clearError();
      }
      
      updateAriaLive();
      updateSubmitButton();

      // Auto-submit when valid (length 8 as per original code)
      if (validation.length === 8 && emailValid && validation.isValid) {
        setTimeout(() => loginForm.requestSubmit(), 300);
      }
    }

    // Login handler (from useLogin.ts logic)
    async function handleLogin(e) {
      e.preventDefault();
      
      const validation = validatePin(pin);
      if (!emailValid || !validation.isValid) {
        showError('Please enter valid email and PIN');
        return;
      }

      loading = true;
      loginButton.classList.add('loading');
      loginButton.disabled = true;
      loginButton.innerHTML = '<span class="button-text">SIGN IN</span><span class="button-spinner"></span>';
      clearError();
      clearSuccess();

      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/demo`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email, pin })
        });

        const data = await response.json();

        if (response.ok && data.token) {
          // Store auth data
          localStorage.setItem('zantara_access_token', data.token);
          localStorage.setItem('zantara_user_email', email);
          if (data.user && data.user.name) {
            localStorage.setItem('zantara_user_name', data.user.name);
          }

          showSuccess('Login successful! Redirecting...');
          
          setTimeout(() => {
            window.location.href = '/chat.html';
          }, 1000);
        } else {
          throw new Error(data.error || data.message || 'Login failed');
        }
      } catch (error) {
        console.error('Login error:', error);
        showError(error.message || 'Login failed. Please try again.');
        
        // Reset PIN
        pin = '';
        pinInputs.forEach(input => {
          input.value = '';
          input.classList.remove('filled');
        });
        pinInputs[0].focus();
      } finally {
        loading = false;
        loginButton.classList.remove('loading');
        loginButton.innerHTML = '<span class="button-text">SIGN IN</span>';
        updateSubmitButton();
      }
    }

    loginForm.addEventListener('submit', handleLogin);

    // Auto-focus email on load
    emailInput.focus();

    // Check if already logged in (skip validation for demo auth)
    const existingToken = localStorage.getItem('zantara_access_token');
    if (existingToken) {
      console.log('✅ Token found, redirecting to chat...');
      window.location.href = '/chat.html';
    }
  </script>
</body>
</html>
