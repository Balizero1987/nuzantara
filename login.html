<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZANTARA - Login</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { background: #2B2B2B !important; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; min-height: 100vh; }
    .login-container { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; background: #2B2B2B; }
    .bali-zero-logo { width: auto; height: auto; max-width: 202px; margin-bottom: 3rem; }
    .login-form-wrapper { width: 100%; max-width: 380px; }
    .welcome-message { padding: 1rem; margin-bottom: 1rem; border-radius: 0.375rem; text-align: center; font-size: 0.875rem; opacity: 0; transition: opacity 0.3s; }
    .welcome-message.show { opacity: 1; }
    .welcome-message.success { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: rgba(34, 197, 94, 0.95); }
    .login-form { background: #323232 !important; padding: 3rem 2.5rem; width: 100%; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); }
    .form-group { margin-bottom: 1.5rem; }
    .form-label { color: rgba(255, 255, 255, 0.9); display: block; margin-bottom: 0.75rem; font-weight: 500; font-size: 0.875rem; letter-spacing: 1px; text-transform: uppercase; }
    .form-input { background: #262626 !important; border: 1px solid #3a3a3a !important; color: rgba(255, 255, 255, 0.95) !important; padding: 0.875rem 1rem; width: 100%; font-size: 1rem; }
    .form-input:focus { outline: none; background: rgba(255, 255, 255, 0.08) !important; border-bottom: 2px solid rgba(217, 32, 39, 0.8) !important; }
    .form-input::placeholder { color: #777 !important; }
    .pin-otp-wrapper { display: flex; gap: 0.5rem; justify-content: center; }
    .pin-otp-slot { width: 3rem; height: 3.5rem; background: #262626 !important; border: 1px solid #3a3a3a !important; color: rgba(255, 255, 255, 0.95) !important; font-size: 1.25rem; text-align: center; }
    .pin-otp-slot:focus { outline: none; background: rgba(255, 255, 255, 0.08) !important; border-bottom: 2px solid rgba(217, 32, 39, 0.8) !important; }
    .login-button { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(217, 32, 39, 0.5) !important; color: rgba(255, 255, 255, 0.95); padding: 0.875rem 2rem; width: 100%; font-weight: 500; font-size: 1rem; cursor: pointer; margin-top: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .login-button:hover:not(:disabled) { background: rgba(217, 32, 39, 0.9) !important; }
    .login-button:disabled { opacity: 0.5; cursor: not-allowed; }
    .button-spinner { width: 1rem; height: 1rem; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-message { margin-top: 1rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: rgba(239, 68, 68, 0.95); font-size: 0.875rem; opacity: 0; transition: opacity 0.3s; }
    .error-message.show { opacity: 1; }
    .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }
  </style>
</head>
<body>
  <div class="login-container">
    <img src="assets/images/logo1-zantara.svg" alt="ZANTARA" class="bali-zero-logo" />
    <div class="login-form-wrapper">
      <div id="welcomeMessage" class="welcome-message"></div>
      <form id="loginForm" class="login-form">
        <div id="ariaLive" aria-live="polite" class="sr-only"></div>
        <div class="form-group">
          <label for="email" class="form-label">Email Address</label>
          <input id="email" type="email" class="form-input" placeholder="your.email@example.com" required autocomplete="email" />
        </div>
        <div class="form-group">
          <label class="form-label">Security PIN</label>
          <div class="pin-otp-wrapper">
            <input type="text" class="pin-otp-slot" maxlength="1" data-index="0" />
            <input type="text" class="pin-otp-slot" maxlength="1" data-index="1" />
            <input type="text" class="pin-otp-slot" maxlength="1" data-index="2" />
            <input type="text" class="pin-otp-slot" maxlength="1" data-index="3" />
            <input type="text" class="pin-otp-slot" maxlength="1" data-index="4" />
            <input type="text" class="pin-otp-slot" maxlength="1" data-index="5" />
          </div>
        </div>
        <button type="submit" class="login-button"><span>SIGN IN</span></button>
        <div id="errorMessage" class="error-message" role="alert"></div>
      </form>
    </div>
  </div>
  <script>
    const API='https://nuzantara-rag.fly.dev';
    const form=document.getElementById('loginForm'),email=document.getElementById('email'),pins=document.querySelectorAll('.pin-otp-slot'),btn=form.querySelector('.login-button'),err=document.getElementById('errorMessage'),wel=document.getElementById('welcomeMessage');
    let loading=false,lastAttempt=0;
    function vEmail(e){return e.length>0&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}
    function vPin(p){const n=p.replace(/\D/g,''),l=n.length;return{ok:l===6,len:l}}
    function show(el,cls){el.classList.add('show');if(cls)el.classList.add(cls)}
    function hide(el){el.classList.remove('show','success')}
    pins.forEach((input,i)=>{
      input.addEventListener('input',e=>{e.target.value=e.target.value.replace(/\D/g,'');if(e.target.value&&i<5)pins[i+1].focus();checkAuto()});
      input.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!e.target.value&&i>0)pins[i-1].focus()});
      input.addEventListener('paste',e=>{e.preventDefault();const p=e.clipboardData.getData('text').replace(/\D/g,'').split('').slice(0,6);p.forEach((c,j)=>{if(pins[j])pins[j].value=c});if(p.length>0)pins[Math.min(p.length,5)].focus();checkAuto()});
    });
    email.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();pins[0].focus()}});
    function checkAuto(){const pin=Array.from(pins).map(i=>i.value).join(''),e=email.value.trim();if(pin.length===6&&vEmail(e))setTimeout(()=>form.requestSubmit(),300)}
    form.addEventListener('submit',async e=>{
      e.preventDefault();
      const now=Date.now();if(now-lastAttempt<2000){err.textContent=`Wait ${Math.ceil((2000-(now-lastAttempt))/1000)}s`;show(err);return}
      lastAttempt=now;
      const em=email.value.trim(),pin=Array.from(pins).map(i=>i.value).join('');
      if(!em||!pin){err.textContent='Enter email and PIN';show(err);return}
      const{ok,len}=vPin(pin);if(!ok){err.textContent='PIN must be 6 digits';show(err);return}
      hide(err);hide(wel);loading=true;btn.disabled=true;
      const sp=document.createElement('span');sp.className='button-spinner';btn.appendChild(sp);
      try{
        const r=await fetch(`${API}/api/auth/demo`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:em,pin:pin})});
        if(!r.ok)throw new Error((await r.json()).detail||'Login failed');
        const d=await r.json();
        const u=d.user||d.data?.user,t=d.token||d.accessToken||d.data?.token,ex=d.expiresIn||d.expires_in||d.data?.expiresIn||3600;
        localStorage.setItem('zantara-token',JSON.stringify({token:t,expiresAt:Date.now()+ex*1000}));
        localStorage.setItem('zantara-user',JSON.stringify(u));
        localStorage.setItem('zantara-session',JSON.stringify({id:u.id||`s_${Date.now()}`,createdAt:Date.now(),lastActivity:Date.now()}));
        wel.textContent=`Welcome, ${u.name||u.email}! ðŸŽ‰`;show(wel,'success');
        setTimeout(()=>window.location.href='/chat.html',1500);
      }catch(error){err.textContent=error.message;show(err);sp.remove();btn.disabled=false;pins.forEach(p=>p.value='');pins[0].focus()}
    });
    window.addEventListener('DOMContentLoaded',()=>email.focus());
  </script>
</body>
</html>
