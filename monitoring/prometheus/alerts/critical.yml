# ZANTARA Critical Alerts
# Production-critical failure conditions requiring immediate action

groups:
  - name: zantara_critical_alerts
    interval: 30s
    rules:
      # Service Down Alert
      - alert: ServiceDown
        expr: up{job=~"zantara-.*"} == 0
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "ZANTARA service {{ $labels.job }} is down"
          description: "Service {{ $labels.job }} on {{ $labels.instance }} has been down for more than 1 minute."
          runbook: "https://docs.zantara.com/runbooks/service-down"

      # High Error Rate
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(zantara_http_requests_total{status=~"5.."}[5m])) by (job)
            /
            sum(rate(zantara_http_requests_total[5m])) by (job)
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "High error rate on {{ $labels.job }}"
          description: "Error rate is {{ $value | humanizePercentage }} on {{ $labels.job }} (threshold: 5%)"
          runbook: "https://docs.zantara.com/runbooks/high-error-rate"

      # AI Service Failure
      - alert: AIServiceFailure
        expr: rate(zantara_ai_requests_total[5m]) == 0 and zantara_http_requests_total > 100
        for: 3m
        labels:
          severity: critical
          team: ai
        annotations:
          summary: "AI service not responding"
          description: "No AI requests processed in last 5 minutes despite active traffic"
          runbook: "https://docs.zantara.com/runbooks/ai-service-failure"

      # Database Connection Pool Exhausted
      - alert: DatabaseConnectionPoolExhausted
        expr: zantara_db_connections_active >= 95
        for: 2m
        labels:
          severity: critical
          team: database
        annotations:
          summary: "Database connection pool nearly exhausted"
          description: "Active connections: {{ $value }} (threshold: 95)"
          runbook: "https://docs.zantara.com/runbooks/db-pool-exhausted"

      # Memory Usage Critical
      - alert: MemoryUsageCritical
        expr: zantara_memory_usage_mb > 1800
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Critical memory usage on {{ $labels.instance }}"
          description: "Memory usage: {{ $value | humanize }}MB (threshold: 1800MB, limit: 2048MB)"
          runbook: "https://docs.zantara.com/runbooks/memory-critical"

      # Response Time P95 Exceeds Target
      - alert: SlowResponseTime
        expr: |
          histogram_quantile(0.95, 
            sum(rate(zantara_request_duration_seconds_bucket[5m])) by (le, job)
          ) > 2
        for: 10m
        labels:
          severity: warning
          team: performance
        annotations:
          summary: "P95 response time exceeds 2s on {{ $labels.job }}"
          description: "P95 latency: {{ $value | humanizeDuration }} (target: <2s)"
          runbook: "https://docs.zantara.com/runbooks/slow-response"

      # Cache Hit Rate Too Low
      - alert: LowCacheHitRate
        expr: |
          (
            sum(rate(zantara_cache_hits_total[10m]))
            /
            (sum(rate(zantara_cache_hits_total[10m])) + sum(rate(zantara_cache_misses_total[10m])))
          ) < 0.5
        for: 15m
        labels:
          severity: warning
          team: performance
        annotations:
          summary: "Cache hit rate below 50%"
          description: "Cache hit rate: {{ $value | humanizePercentage }} (target: >70%)"
          runbook: "https://docs.zantara.com/runbooks/low-cache-hit-rate"

      # AI Token Usage Spike
      - alert: AITokenUsageSpike
        expr: |
          rate(zantara_ai_tokens_used_total[5m]) > 10000
        for: 5m
        labels:
          severity: warning
          team: ai
        annotations:
          summary: "Unusual AI token usage spike"
          description: "Token rate: {{ $value }}/s (threshold: 10000/5min)"
          runbook: "https://docs.zantara.com/runbooks/token-spike"

      # Redis Latency High
      - alert: RedisLatencyHigh
        expr: zantara_redis_latency_ms > 100
        for: 5m
        labels:
          severity: warning
          team: infrastructure
        annotations:
          summary: "Redis latency is high"
          description: "Latency: {{ $value }}ms (threshold: 100ms)"
          runbook: "https://docs.zantara.com/runbooks/redis-latency"

      # SSE Connection Latency
      - alert: SSELatencyHigh
        expr: zantara_sse_latency_ms > 500
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "SSE connection latency is high"
          description: "Latency: {{ $value }}ms (threshold: 500ms)"
          runbook: "https://docs.zantara.com/runbooks/sse-latency"

      # Frontend Availability
      - alert: FrontendDown
        expr: probe_success{job="blackbox", instance="https://zantara.balizero.com"} == 0
        for: 2m
        labels:
          severity: critical
          team: frontend
        annotations:
          summary: "Frontend is unreachable"
          description: "https://zantara.balizero.com has been down for 2 minutes"
          runbook: "https://docs.zantara.com/runbooks/frontend-down"
