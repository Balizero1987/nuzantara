# ============================================================
# üöÄ NUZANTARA LangGraph + AutoGen + Claude (v1.0.1 Compatible)
# ============================================================

import os
from dotenv import load_dotenv
from langgraph.graph import StateGraph, END, PythonNode
from autogen import AssistantAgent, GroupChat, GroupChatManager
from anthropic import Anthropic

# ====== INIT ======
load_dotenv()
client = Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))

SONNET = "claude-3-sonnet-20240229"
HAIKU = "claude-3-haiku-20240307"

# ====== AUTO-GEN TEAM ======
code_agent = AssistantAgent(name="CodeAgent", llm=HAIKU)
test_agent = AssistantAgent(name="TestAgent", llm="llama-8b-local")
review_agent = AssistantAgent(name="ReviewAgent", llm=HAIKU)

group = GroupChat(agents=[code_agent, test_agent, review_agent], messages=[])
manager = GroupChatManager(group)

# ====== NODI ======
def analyze_node(state):
    print("üîç [ANALYZE] Analizzo log e genero patch...")
    logs = state.get("logs", "no logs provided")
    prompt = f"""
    You are Claude Sonnet. Analyze these logs and generate atomic code patches.
    Return JSON: {{"patches":[{{"file":"...","hunks":[],"test":""}}], "plan":"..."}}
    Logs:\n{logs}
    """
    try:
        msg = client.messages.create(
            model=SONNET, max_tokens=2000,
            messages=[{"role": "user", "content": prompt}]
        )
        state["patches_plan"] = msg.content[0].text
    except Exception as e:
        print("‚ö†Ô∏è Errore ANALYZE:", e)
        state["patches_plan"] = "mock_patch_plan"
    return state

def plan_node(state):
    print("üß© [PLAN] Creo sottotask...")
    prompt = f"""
    You are Claude Haiku. Break down this patch plan into subtasks.
    Plan:\n{state.get("patches_plan")}
    """
    try:
        msg = client.messages.create(
            model=HAIKU, max_tokens=800,
            messages=[{"role": "user", "content": prompt}]
        )
        state["tasks"] = msg.content[0].text
    except Exception as e:
        print("‚ö†Ô∏è Errore PLAN:", e)
        state["tasks"] = "mock_tasks"
    return state

def execute_node(state):
    print("üöÄ [EXECUTE] Avvio AutoGen team (Code/Test/Review)...")
    try:
        manager.run(f"Apply and test these patches:\n{state['patches_plan']}")
        state["execution_status"] = "done"
    except Exception as e:
        print("‚ö†Ô∏è Errore EXECUTE:", e)
        state["execution_status"] = "mock_execution"
    return state

def validate_node(state):
    print("üß† [VALIDATE] Controllo qualit√† finale...")
    prompt = f"""
    Review the results:
    {state.get('execution_status')}
    Are all patches consistent, tests passed, and code safe?
    Answer JSON: {{"approved": true/false, "summary": "..."}}
    """
    try:
        msg = client.messages.create(
            model=SONNET, max_tokens=800,
            messages=[{"role": "user", "content": prompt}]
        )
        state["validation"] = msg.content[0].text
    except Exception as e:
        print("‚ö†Ô∏è Errore VALIDATE:", e)
        state["validation"] = "mock_validation"
    return state

# ====== COSTRUZIONE GRAFO ======
graph = StateGraph()
graph.add_node("ANALYZE", PythonNode(analyze_node))
graph.add_node("PLAN", PythonNode(plan_node))
graph.add_node("EXECUTE", PythonNode(execute_node))
graph.add_node("VALIDATE", PythonNode(validate_node))

graph.set_entry_point("ANALYZE")
graph.add_edge("ANALYZE", "PLAN")
graph.add_edge("PLAN", "EXECUTE")
graph.add_edge("EXECUTE", "VALIDATE")
graph.add_edge("VALIDATE", END)

app = graph.compile()

# ====== AVVIO ======
if __name__ == "__main__":
    print("‚öôÔ∏è Avvio LangGraph Orchestration per NUZANTARA...")
    state = {"logs": "Error: pricing file not found in backend."}
    result = app.invoke(state)
    print("\n‚úÖ FINAL STATE:\n", result)
