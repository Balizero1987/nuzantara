# ============================================================
# üöÄ NUZANTARA LangGraph + AutoGen + Claude (MVP Orchestration)
# ============================================================

import os
from dotenv import load_dotenv
from langgraph.graph import StateGraph, END
from langgraph.func import entrypoint, task
from autogen import AssistantAgent, GroupChat, GroupChatManager
from anthropic import Anthropic

# ====== INIT ======
load_dotenv()
client = Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))

SONNET = "claude-3-sonnet-20240229"
HAIKU = "claude-3-haiku-20240307"

# ====== AUTO-GEN TEAM ======
config_list = [
    {"model": "claude-3-haiku-20240307", "api_key": os.getenv("ANTHROPIC_API_KEY")},
    {"model": "llama-8b-local"}
]

code_agent = AssistantAgent(name="CodeAgent", llm_config=config_list[0])
test_agent = AssistantAgent(name="TestAgent", llm_config=config_list[1])
review_agent = AssistantAgent(name="ReviewAgent", llm_config=config_list[0])

group = GroupChat(agents=[code_agent, test_agent, review_agent], messages=[])
manager = GroupChatManager(group)

# ====== NODI DEL GRAFO ======

@task
def analyze_node(state):
    print("üîç [ANALYZE] Analizzo log e genero patch...")
    logs = state.get("logs", "no logs provided")
    prompt = f"""
    Analyze the following logs and generate atomic code patches.
    Return JSON: {{"patches":[{{"file":"...","hunks":[],"test":""}}], "plan":"..."}}
    Logs:\n{logs}
    """
    try:
        msg = client.messages.create(
            model=SONNET,
            max_tokens=2000,
            messages=[{"role": "user", "content": prompt}]
        )
        state["patches_plan"] = msg.content[0].text
    except Exception as e:
        print("‚ö†Ô∏è Errore ANALYZE:", e)
        state["patches_plan"] = "mock_patch_plan"
    return state


@task
def plan_node(state):
    print("üß© [PLAN] Suddivido la patch in subtasks...")
    prompt = f"""
    Break down this patch plan into detailed subtasks:
    {state.get("patches_plan")}
    """
    try:
        msg = client.messages.create(
            model=HAIKU,
            max_tokens=800,
            messages=[{"role": "user", "content": prompt}]
        )
        state["tasks"] = msg.content[0].text
    except Exception as e:
        print("‚ö†Ô∏è Errore PLAN:", e)
        state["tasks"] = "mock_tasks"
    return state


@task
def execute_node(state):
    print("üöÄ [EXECUTE] AutoGen team in azione (Code/Test/Review)...")
    try:
        manager.run(f"Apply and test these patches:\n{state['patches_plan']}")
        state["execution_status"] = "done"
    except Exception as e:
        print("‚ö†Ô∏è Errore EXECUTE:", e)
        state["execution_status"] = "mock_execution"
    return state


@task
def validate_node(state):
    print("üß† [VALIDATE] Controllo finale...")
    prompt = f"""
    Review the results:
    {state.get('execution_status')}
    Are all patches consistent, tests passed, and code safe?
    Answer JSON: {{"approved": true/false, "summary": "..."}}
    """
    try:
        msg = client.messages.create(
            model=SONNET,
            max_tokens=800,
            messages=[{"role": "user", "content": prompt}]
        )
        state["validation"] = msg.content[0].text
    except Exception as e:
        print("‚ö†Ô∏è Errore VALIDATE:", e)
        state["validation"] = "mock_validation"
    return state


# ====== DEFINIZIONE DEL GRAFO ======

@entrypoint()
def main(state: dict):
    graph = StateGraph()

    graph.add_node("ANALYZE", analyze_node)
    graph.add_node("PLAN", plan_node)
    graph.add_node("EXECUTE", execute_node)
    graph.add_node("VALIDATE", validate_node)

    graph.set_entry_point("ANALYZE")
    graph.add_edge("ANALYZE", "PLAN")
    graph.add_edge("PLAN", "EXECUTE")
    graph.add_edge("EXECUTE", "VALIDATE")
    graph.add_edge("VALIDATE", END)

    app = graph.compile()
    result = app.run(state)
    return result


# ====== AVVIO ======
if __name__ == "__main__":
    print("‚öôÔ∏è Avvio LangGraph Orchestration per NUZANTARA...")

    state = {"logs": "Error: pricing file not found in backend."}

    # In LangGraph 1.0, main √® gi√† un oggetto Pregel
    result = main.run(state)

    print("\n‚úÖ FINAL STATE:\n", result)
