worker_processes 1;

error_log /dev/stdout info;

events { worker_connections 1024; }

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    access_log /dev/stdout;

    server {
        listen 80;
        listen [::]:80; # Ascolta anche su IPv6

        root /usr/share/nginx/html;
        index index.html;

        # FLY.IO DNS RESOLVER (IPv6 ONLY)
        # ipv6=on Ã¨ fondamentale
        resolver [fdaa::3] valid=5s ipv6=on;

        location / {
            try_files $uri $uri/ /index.html;
        }

        location /api/ {
            # Forziamo la risoluzione DNS a ogni richiesta
            set $upstream_endpoint "http://nuzantara-rag.internal:8080";
            
            # Rewrite: rimuove /api dal path prima di fare proxy
            # /api/bali-zero/chat-stream -> /bali-zero/chat-stream
            rewrite ^/api/(.*) /$1 break;
            
            # Proxy Pass
            proxy_pass $upstream_endpoint;
            
            # Headers
            proxy_http_version 1.1;
            proxy_set_header Host "nuzantara-rag.internal"; # Host header esplicito
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass_header Authorization;
        }
    }
}
