class ZantaraClient{constructor(e={}){this.config={apiUrl:e.apiUrl||"https://nuzantara-rag.fly.dev",authEndpoint:e.authEndpoint||"/api/auth/demo",chatEndpoint:e.chatEndpoint||"/api/v3/zantara/unified",maxRetries:e.maxRetries||3,retryDelay:e.retryDelay||1e3,sessionKey:"zantara-session",tokenKey:"zantara-token",historyKey:"zantara-history",...e},this.token=null,this.sessionId=null,this.messages=[],this.isStreaming=!1,this.retryCount=0,this.eventSource=null,this.loadSession(),this.loadHistory()}async authenticate(e="demo"){try{const t=localStorage.getItem(this.config.tokenKey);if(t){const e=JSON.parse(t);if(e.expiresAt>Date.now())return this.token=e.token,console.log("âœ… Using cached JWT token"),this.token}console.log("ðŸ” Authenticating...");const s=await fetch(`${this.config.apiUrl}${this.config.authEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e})});if(!s.ok)throw new Error(`Auth failed: ${s.status}`);const o=await s.json();return this.token=o.token,localStorage.setItem(this.config.tokenKey,JSON.stringify({token:this.token,expiresAt:Date.now()+1e3*(o.expiresIn||3600)})),console.log("âœ… Authentication successful"),this.token}catch(e){return console.error("âŒ Authentication failed:",e),this.token="demo-token",this.token}}loadSession(){const e=localStorage.getItem(this.config.sessionKey);if(e){const t=JSON.parse(e);this.sessionId=t.id,console.log(`ðŸ“ Loaded session: ${this.sessionId}`)}else this.sessionId=this.generateSessionId(),this.saveSession(),console.log(`âœ¨ Created new session: ${this.sessionId}`)}saveSession(){localStorage.setItem(this.config.sessionKey,JSON.stringify({id:this.sessionId,createdAt:Date.now(),lastActivity:Date.now()}))}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async ensureSession(){let e=localStorage.getItem("zantara-session-id");return e||(e=this.sessionId,localStorage.setItem("zantara-session-id",e)),e}async updateSession(e){console.log(`ðŸ’¾ Session saved to localStorage (${e.length} messages)`)}loadHistory(){try{const e=localStorage.getItem(this.config.historyKey);e&&(this.messages=JSON.parse(e),console.log(`ðŸ“š Loaded ${this.messages.length} messages from history`))}catch(e){console.error("Failed to load history:",e),this.messages=[]}}saveHistory(){try{const e=this.messages.slice(-50);localStorage.setItem(this.config.historyKey,JSON.stringify(e))}catch(e){console.error("Failed to save history:",e)}}addMessage(e){this.messages.push({...e,id:`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:e.timestamp||new Date}),this.saveHistory(),this.saveSession()}clearHistory(){this.messages=[],localStorage.removeItem(this.config.historyKey),console.log("ðŸ—‘ï¸  History cleared")}async sendMessage(e,t={}){try{await this.authenticate();const s=await this.fetchWithRetry(`${this.config.apiUrl}${this.config.chatEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify({query:e,user_id:this.sessionId,stream:!1,...t})});if(!s.ok)throw new Error(`API error: ${s.status} ${s.statusText}`);const o=await s.json();if(!o.success)throw new Error(o.error||"Request failed");return{content:o.data?.response||o.data?.answer||"No response",sources:o.data?.sources||[],metadata:o.metadata||{}}}catch(e){throw console.error("âŒ sendMessage error:",e),e}}async sendMessageStream(e,t={}){const{onStart:s=()=>{},onToken:o=()=>{},onComplete:r=()=>{},onError:n=()=>{}}=t;try{await this.authenticate(),this.isStreaming=!0,s(),await this.updateSession(this.messages);const t=await this.ensureSession(),a=new URL(`${this.config.apiUrl}/bali-zero/chat-stream`);a.searchParams.append("query",e),a.searchParams.append("session_id",t);const i=window.UserContext?.user?.email||"demo@example.com";a.searchParams.append("user_email",i),console.log(`ðŸ”Œ Connecting to: ${a.toString()}`),this.eventSource=new EventSource(a.toString());let c="";this.eventSource.onopen=()=>{console.log("âœ… EventSource connection opened (readyState:",this.eventSource.readyState,")")},this.eventSource.onmessage=e=>{try{if("[DONE]"===e.data)return this.eventSource.close(),this.isStreaming=!1,void r(c);const t=JSON.parse(e.data),s=t.text||t.content||t.token||"";s&&(c+=s,o(s,c))}catch(t){console.warn("Failed to parse SSE data:",e.data,t)}},this.eventSource.onerror=e=>{console.error("âŒ EventSource error:",{readyState:this.eventSource.readyState,url:this.eventSource.url,withCredentials:this.eventSource.withCredentials,error:e}),this.eventSource.readyState===EventSource.CONNECTING?console.error("ðŸ”´ EventSource: Still connecting, connection refused or CORS blocked"):this.eventSource.readyState===EventSource.CLOSED&&console.error("ðŸ”´ EventSource: Connection closed unexpectedly"),this.eventSource.close(),this.isStreaming=!1,n(e)},setTimeout(()=>{this.isStreaming&&c&&(this.eventSource.close(),this.isStreaming=!1,r(c))},6e4)}catch(e){throw console.error("âŒ Streaming error:",e),this.isStreaming=!1,this.eventSource&&this.eventSource.close(),n(e),e}}async processSSEStream(e,t,s){const o=e.body.getReader(),r=new TextDecoder;let n="",a="";try{for(;this.isStreaming;){const{done:e,value:s}=await o.read();if(e){if(n.trim()){const e=this.parseSSEData(n);e&&(a+=e,t(e,a))}break}n+=r.decode(s,{stream:!0});const i=n.split("\n\n");n=i.pop()||"";for(const e of i){if(!e.trim())continue;const s=this.parseSSEData(e);s&&(a+=s,t(s,a))}}this.isStreaming=!1,s(a)}catch(e){throw this.isStreaming=!1,e}}parseSSEData(e){try{const t=e.split("\n");for(const e of t)if(e.startsWith("data: ")){const t=e.slice(6).trim();if("[DONE]"===t)return null;const s=JSON.parse(t);return s.token||s.content||s.text||""}return null}catch(t){return console.warn("Failed to parse SSE data:",e,t),null}}stopStream(){this.isStreaming=!1,this.eventSource&&(this.eventSource.close(),this.eventSource=null),console.log("â¹ï¸  Stream stopped")}async fetchWithRetry(e,t,s=0){try{const s=await fetch(e,t);if(s.ok)return this.retryCount=0,s;if(s.status>=400&&s.status<500)throw new Error(`Client error: ${s.status}`);throw new Error(`Server error: ${s.status}`)}catch(o){if(s>=this.config.maxRetries)throw console.error(`âŒ Max retries (${this.config.maxRetries}) reached`),o;const r=this.config.retryDelay*Math.pow(2,s);return console.log(`ðŸ”„ Retry ${s+1}/${this.config.maxRetries} in ${r}ms...`),await new Promise(e=>setTimeout(e,r)),this.fetchWithRetry(e,t,s+1)}}renderMarkdown(e){if(!e)return"";let t=e;return t=t.replace(/^### (.*$)/gim,"<h3>$1</h3>"),t=t.replace(/^## (.*$)/gim,"<h2>$1</h2>"),t=t.replace(/^# (.*$)/gim,"<h1>$1</h1>"),t=t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__(.*?)__/g,"<strong>$1</strong>"),t=t.replace(/\*(.*?)\*/g,"<em>$1</em>"),t=t.replace(/_(.*?)_/g,"<em>$1</em>"),t=t.replace(/```([\s\S]*?)```/g,"<pre><code>$1</code></pre>"),t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>'),t=t.replace(/^\* (.*$)/gim,"<li>$1</li>"),t=t.replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>"),t=t.replace(/\n\n/g,"</p><p>"),t=t.replace(/\n/g,"<br>"),t.startsWith("<")||(t=`<p>${t}</p>`),t}getErrorMessage(e){if(!navigator.onLine)return{type:"network",title:"No Internet Connection",message:"Please check your internet connection and try again.",canRetry:!0};const t=e.toString().toLowerCase();return t.includes("timeout")?{type:"timeout",title:"Request Timeout",message:"The request took too long. Please try again.",canRetry:!0}:t.includes("401")||t.includes("auth")?{type:"auth",title:"Authentication Error",message:"Your session has expired. Please refresh the page.",canRetry:!1}:t.includes("403")?{type:"forbidden",title:"Access Denied",message:"You don't have permission to access this resource.",canRetry:!1}:t.includes("429")?{type:"ratelimit",title:"Too Many Requests",message:"Please wait a moment before trying again.",canRetry:!0}:t.includes("500")||t.includes("503")?{type:"server",title:"Server Error",message:"Our servers are experiencing issues. Please try again later.",canRetry:!0}:{type:"unknown",title:"Something Went Wrong",message:"An unexpected error occurred. Please try again.",canRetry:!0}}}"undefined"!=typeof window&&(window.ZantaraClient=ZantaraClient);