<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZANTARA v4 - Integration Test</title>
  <style>
    body {
      font-family: monospace;
      background: #0c0c0c;
      color: #d4af37;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 { color: #d4af37; }
    .test-section {
      border: 1px solid #d4af37;
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
    }
    .status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 4px;
      margin-left: 10px;
    }
    .status.success { background: #228b22; color: white; }
    .status.error { background: #dc143c; color: white; }
    .status.pending { background: #ffa500; color: white; }
    button {
      background: transparent;
      border: 2px solid #d4af37;
      color: #d4af37;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 25px;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: rgba(212, 175, 55, 0.1);
    }
    #response {
      background: rgba(212, 175, 55, 0.05);
      border: 1px solid #d4af37;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
      min-height: 100px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .log {
      font-size: 12px;
      color: #888;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>ðŸ”Œ ZANTARA v4 - Integration Test</h1>

  <div class="test-section">
    <h2>1. Backend Health Check</h2>
    <button onclick="testBackendHealth()">Test Backend</button>
    <span id="health-status" class="status pending">Pending</span>
    <pre id="health-result" class="log"></pre>
  </div>

  <div class="test-section">
    <h2>2. Session Store Test</h2>
    <button onclick="testSessionStore()">Test Session</button>
    <span id="session-status" class="status pending">Pending</span>
    <pre id="session-result" class="log"></pre>
  </div>

  <div class="test-section">
    <h2>3. SSE Streaming Test (GET /bali-zero/chat-stream)</h2>
    <button onclick="testSSEStreaming()">Test Streaming</button>
    <span id="sse-status" class="status pending">Pending</span>
    <div id="response"></div>
    <pre id="sse-result" class="log"></pre>
  </div>

  <div class="test-section">
    <h2>4. Full Integration Test (ZantaraClient)</h2>
    <button onclick="testFullIntegration()">Test Full Stack</button>
    <span id="full-status" class="status pending">Pending</span>
    <div id="full-response"></div>
    <pre id="full-result" class="log"></pre>
  </div>

  <!-- Load ZantaraClient -->
  <script src="js/zantara-client.js"></script>

  <script>
    const API_URL = 'https://nuzantara-rag.fly.dev';

    // Test 1: Backend Health
    async function testBackendHealth() {
      const statusEl = document.getElementById('health-status');
      const resultEl = document.getElementById('health-result');

      statusEl.textContent = 'Testing...';
      statusEl.className = 'status pending';

      try {
        const response = await fetch(`${API_URL}/health`);
        const data = await response.json();

        resultEl.textContent = JSON.stringify(data, null, 2);

        if (data.status === 'healthy') {
          statusEl.textContent = 'âœ… Healthy';
          statusEl.className = 'status success';
        } else {
          statusEl.textContent = 'âš ï¸ Degraded';
          statusEl.className = 'status error';
        }
      } catch (error) {
        statusEl.textContent = 'âŒ Failed';
        statusEl.className = 'status error';
        resultEl.textContent = error.message;
      }
    }

    // Test 2: Session Store
    async function testSessionStore() {
      const statusEl = document.getElementById('session-status');
      const resultEl = document.getElementById('session-result');

      statusEl.textContent = 'Testing...';
      statusEl.className = 'status pending';

      try {
        const sessionId = `test_${Date.now()}`;

        // Create session
        const createResponse = await fetch(`${API_URL}/sessions/${sessionId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            history: [
              {role: 'user', content: 'Test message 1'},
              {role: 'assistant', content: 'Test response 1'}
            ]
          })
        });

        resultEl.textContent = `Session created: ${sessionId}\n`;

        // Retrieve session
        const getResponse = await fetch(`${API_URL}/sessions/${sessionId}`);
        const data = await getResponse.json();

        resultEl.textContent += `Retrieved: ${JSON.stringify(data, null, 2)}`;

        statusEl.textContent = 'âœ… Working';
        statusEl.className = 'status success';
      } catch (error) {
        statusEl.textContent = 'âŒ Failed';
        statusEl.className = 'status error';
        resultEl.textContent = error.message;
      }
    }

    // Test 3: SSE Streaming (raw EventSource)
    function testSSEStreaming() {
      const statusEl = document.getElementById('sse-status');
      const resultEl = document.getElementById('sse-result');
      const responseEl = document.getElementById('response');

      statusEl.textContent = 'Streaming...';
      statusEl.className = 'status pending';
      responseEl.textContent = '';

      const sessionId = `test_${Date.now()}`;
      const url = new URL(`${API_URL}/bali-zero/chat-stream`);
      url.searchParams.append('query', 'Tell me about B211A visa in 2 sentences');
      url.searchParams.append('session_id', sessionId);
      url.searchParams.append('user_email', 'test@example.com');

      resultEl.textContent = `Connecting to: ${url.toString()}\n`;

      const eventSource = new EventSource(url.toString());
      let accumulated = '';
      let tokenCount = 0;
      const startTime = Date.now();

      eventSource.onmessage = (event) => {
        try {
          if (event.data === '[DONE]') {
            eventSource.close();
            const duration = ((Date.now() - startTime) / 1000).toFixed(2);
            statusEl.textContent = `âœ… Completed (${tokenCount} tokens, ${duration}s)`;
            statusEl.className = 'status success';
            resultEl.textContent += `\nDone! Total: ${tokenCount} tokens in ${duration}s`;
            return;
          }

          const data = JSON.parse(event.data);
          const token = data.text || data.content || '';

          if (token) {
            accumulated += token;
            tokenCount++;
            responseEl.textContent = accumulated;
          }
        } catch (error) {
          console.warn('Parse error:', error);
        }
      };

      eventSource.onerror = (error) => {
        console.error('EventSource error:', error);
        eventSource.close();
        statusEl.textContent = 'âŒ Failed';
        statusEl.className = 'status error';
        resultEl.textContent += `\nError: ${error.message || 'Connection failed'}`;
      };
    }

    // Test 4: Full Integration with ZantaraClient
    async function testFullIntegration() {
      const statusEl = document.getElementById('full-status');
      const resultEl = document.getElementById('full-result');
      const responseEl = document.getElementById('full-response');

      statusEl.textContent = 'Testing...';
      statusEl.className = 'status pending';
      responseEl.textContent = '';

      try {
        const client = new ZantaraClient({
          apiUrl: API_URL
        });

        resultEl.textContent = `Client initialized\nSession: ${client.sessionId}\n`;

        let accumulated = '';
        let tokenCount = 0;
        const startTime = Date.now();

        await client.sendMessageStream('What is KITAS?', {
          onStart: () => {
            resultEl.textContent += 'Stream started...\n';
          },
          onToken: (token, fullText) => {
            tokenCount++;
            accumulated = fullText;
            responseEl.textContent = fullText;
          },
          onComplete: (fullText) => {
            const duration = ((Date.now() - startTime) / 1000).toFixed(2);
            statusEl.textContent = `âœ… Success (${tokenCount} tokens, ${duration}s)`;
            statusEl.className = 'status success';
            resultEl.textContent += `\nCompleted! ${tokenCount} tokens in ${duration}s`;
          },
          onError: (error) => {
            statusEl.textContent = 'âŒ Failed';
            statusEl.className = 'status error';
            resultEl.textContent += `\nError: ${error.message}`;
          }
        });

      } catch (error) {
        statusEl.textContent = 'âŒ Failed';
        statusEl.className = 'status error';
        resultEl.textContent += `\nError: ${error.message}`;
      }
    }

    // Auto-run backend health check on load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('Test page loaded');
      testBackendHealth();
    });
  </script>
</body>
</html>
